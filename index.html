<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ping Pong Master - Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a2e22;
            background-image: radial-gradient(#2d4a37 15%, transparent 16%), radial-gradient(#2d4a37 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            color: #ecfdf5;
            overscroll-behavior-y: none;
        }
        .retro-font { font-family: 'Press Start 2P', cursive; }
        .glass-panel {
            background: rgba(16, 185, 129, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(16, 185, 129, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-bounce-paddle { animation: bounce-paddle 2s infinite; }
        @keyframes bounce-paddle {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(10deg); }
        }
        .player-avatar {
            background: linear-gradient(135deg, #34d399 0%, #059669 100%);
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-2 md:p-4 overflow-x-hidden transition-colors duration-500">

    <!-- INDICADOR DE VERSI√ìN -->
    <div class="fixed top-0 right-0 bg-emerald-900/80 backdrop-blur text-emerald-400 text-[10px] px-2 py-1 z-50 font-mono border-b border-l border-emerald-500/30 rounded-bl-lg flex gap-2 items-center">
        <span>v3.0 (Stats & SFX)</span>
        <button onclick="toggleFullScreen()" class="hover:text-white"><i class="fas fa-expand"></i></button>
    </div>

    <!-- Header -->
    <header class="w-full max-w-3xl text-center mb-4 mt-2">
        <div class="flex justify-center items-center gap-3 mb-2">
            <i class="fas fa-table-tennis text-2xl md:text-4xl text-orange-400 animate-bounce-paddle"></i>
            <h1 class="text-xl md:text-4xl text-white retro-font text-shadow-md leading-tight">PING PONG<br><span class="text-emerald-400 text-lg md:text-2xl">ONLINE</span></h1>
        </div>
        <!-- Connection Status -->
        <div id="connectionStatus" class="text-xs font-mono text-yellow-500 animate-pulse">
            <i class="fas fa-wifi"></i> Conectando a la nube...
        </div>
        
        <!-- Room Code with Copy -->
        <div id="roomDisplay" class="hidden mt-2 group cursor-pointer transition-all active:scale-95" onclick="copyRoomCode()">
            <div class="bg-emerald-900/80 px-4 py-1 rounded-full border border-emerald-500/50 inline-flex items-center gap-2">
                <span class="text-emerald-400 text-xs uppercase tracking-wider">SALA:</span>
                <span id="roomCodeDisplay" class="text-white font-bold font-mono text-lg tracking-widest">----</span>
                <i class="fas fa-copy text-emerald-600 group-hover:text-white transition-colors text-xs"></i>
            </div>
            <div class="text-[10px] text-emerald-500/50 mt-1 opacity-0 group-hover:opacity-100 transition-opacity">Click para copiar</div>
        </div>
    </header>

    <!-- LOBBY SECTION -->
    <div id="lobbySection" class="w-full max-w-sm glass-panel rounded-xl p-6 mb-8 text-center transition-all duration-500">
        <h2 class="text-xl font-bold text-white mb-6">Bienvenido</h2>
        
        <button onclick="createRoom()" class="w-full bg-orange-500 hover:bg-orange-400 text-white font-bold py-3 px-4 rounded-lg shadow-lg mb-4 transition-transform active:scale-95 flex items-center justify-center gap-2">
            <i class="fas fa-plus-circle"></i> CREAR TORNEO
        </button>
        
        <div class="relative flex py-2 items-center">
            <div class="flex-grow border-t border-emerald-700"></div>
            <span class="flex-shrink-0 mx-4 text-emerald-500 text-xs">O UNIRSE</span>
            <div class="flex-grow border-t border-emerald-700"></div>
        </div>

        <div class="mt-4 flex gap-2">
            <input type="text" id="joinCodeInput" placeholder="C√ìDIGO" maxlength="4" 
                class="flex-1 bg-emerald-900/50 border border-emerald-600 rounded-lg px-4 py-2 text-white text-center font-mono uppercase placeholder-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-400 h-12">
            <button onclick="joinRoom()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-4 rounded-lg transition-colors h-12">
                ENTRAR
            </button>
        </div>
        
        <!-- Sound Enable Prompt -->
        <div class="mt-6 pt-4 border-t border-emerald-800/50">
            <p class="text-xs text-emerald-400 mb-2"><i class="fas fa-volume-up"></i> Sonidos del juego</p>
            <button onclick="initAudio()" id="audioBtn" class="text-xs bg-emerald-900/50 hover:bg-emerald-800 px-3 py-1 rounded text-emerald-300 border border-emerald-700">
                Activar Audio
            </button>
        </div>
    </div>

    <!-- SETUP SECTION -->
    <div id="setupSection" class="w-full max-w-md glass-panel rounded-xl p-4 md:p-6 mb-8 hidden mx-2">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg md:text-xl font-bold text-emerald-300 flex items-center gap-2">
                <i class="fas fa-users"></i> Jugadores
            </h2>
            <button onclick="showStatsModal()" class="text-xs bg-emerald-800/50 hover:bg-emerald-700 px-2 py-1 rounded text-white border border-emerald-600/30">
                <i class="fas fa-chart-bar"></i> Tabla
            </button>
        </div>
        
        <div class="flex gap-2 mb-4">
            <input type="text" id="playerInput" placeholder="Nombre..." 
                class="flex-1 bg-emerald-900/50 border border-emerald-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-400"
                onkeypress="handleEnter(event)">
            <button onclick="addPlayer()" class="bg-emerald-500 hover:bg-emerald-400 text-emerald-950 font-bold py-2 px-4 rounded-lg shadow-lg">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <ul id="playerList" class="space-y-2 mb-6 max-h-60 overflow-y-auto pr-1">
            <!-- Players list -->
        </ul>

        <div class="flex justify-between items-center pt-4 border-t border-emerald-700/50">
            <span class="text-emerald-400 text-sm font-mono" id="playerCount">0 Jugadores</span>
            <button onclick="startTournament()" id="startBtn" disabled
                class="bg-orange-500 hover:bg-orange-400 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-6 rounded-lg shadow-lg active:translate-y-1 transition-all">
                SORTEAR <i class="fas fa-random ml-2"></i>
            </button>
        </div>
    </div>

    <!-- BRACKET SECTION -->
    <div id="bracketSection" class="w-full max-w-6xl hidden flex flex-col h-[80vh]">
        <div class="flex justify-between items-center mb-4 glass-panel p-3 rounded-lg mx-2 shrink-0">
            <h2 class="text-lg font-bold text-white"><i class="fas fa-trophy text-yellow-400 mr-2"></i> Torneo</h2>
            
            <div class="flex gap-2">
                <button onclick="showStatsModal()" class="bg-emerald-600/30 text-emerald-200 border border-emerald-500/50 rounded px-3 py-1 text-xs hover:bg-emerald-600/50 transition-colors">
                    <i class="fas fa-list-ol"></i> Tabla
                </button>
                <button id="showChampionBtn" onclick="showWinnerModal()" class="hidden bg-yellow-500/20 text-yellow-400 border border-yellow-500/50 rounded px-3 py-1 text-xs hover:bg-yellow-500/40 transition-colors font-bold">
                    <i class="fas fa-crown"></i>
                </button>
                <button onclick="showResetModal()" class="text-red-400 border border-red-500/30 rounded px-3 py-1 text-xs hover:bg-red-500/10">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>

        <div id="roundsContainer" class="flex flex-row gap-4 overflow-x-auto pb-8 snap-x snap-mandatory px-4 w-full no-scrollbar h-full items-start">
            <!-- Bracket content -->
        </div>
    </div>

    <!-- STATS MODAL (Tabla de Posiciones) -->
    <div id="statsModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass-panel rounded-xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-emerald-700/50 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white"><i class="fas fa-chart-line text-emerald-400 mr-2"></i> Tabla de Posiciones</h3>
                <button onclick="closeStatsModal()" class="text-emerald-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="overflow-y-auto p-4">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-emerald-500 text-xs uppercase border-b border-emerald-700">
                            <th class="py-2 pl-2">#</th>
                            <th class="py-2">Jugador</th>
                            <th class="py-2 text-center">PJ</th>
                            <th class="py-2 text-center">PG</th>
                            <th class="py-2 text-center">DIF</th>
                        </tr>
                    </thead>
                    <tbody id="statsTableBody" class="text-sm">
                        <!-- Stats Rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Winner Modal -->
    <div id="winnerAnnouncement" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="glass-panel p-8 rounded-2xl border-2 border-yellow-400 animate-pulse text-center max-w-sm w-full shadow-[0_0_50px_rgba(234,179,8,0.5)]">
            <h3 class="text-2xl text-yellow-300 font-bold mb-2">¬°CAMPE√ìN!</h3>
            <div class="text-5xl my-6 font-bold text-white animate-bounce" id="winnerText">üëë</div>
            
            <div class="flex flex-col gap-3 w-full">
                <button onclick="closeWinnerModal(); showStatsModal();" class="bg-transparent border border-yellow-500/50 text-yellow-200 hover:bg-yellow-500/10 font-bold py-3 px-8 rounded-full w-full transition-colors">
                    Ver Tabla Final
                </button>
                <button onclick="showResetModal()" class="bg-yellow-500 text-yellow-900 font-bold py-3 px-8 rounded-full w-full hover:bg-yellow-400 transition-colors shadow-lg">
                    Nuevo Torneo
                </button>
            </div>
        </div>
    </div>

    <!-- Modals & Toasts -->
    <div id="toast" class="fixed bottom-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-[70] pointer-events-none"></div>
    
    <div id="resetModal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-[70] backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl max-w-sm w-full mx-4 text-center border border-red-500/30">
            <h3 class="text-xl font-bold text-white mb-2">¬øReiniciar?</h3>
            <p class="text-emerald-200/70 mb-6">Se perder√°n los resultados actuales.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeResetModal()" class="px-4 py-2 rounded-lg text-emerald-200 border border-emerald-500/30">Cancelar</button>
                <button onclick="confirmReset()" class="px-4 py-2 rounded-lg bg-red-600 text-white font-bold">S√≠, Reiniciar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        try {
            if (typeof __firebase_config !== 'undefined') {
                 firebaseConfig = JSON.parse(__firebase_config);
            } else { throw new Error("No config"); }
        } catch (e) {
            firebaseConfig = {
                apiKey: "__API_KEY__",
                authDomain: "__AUTH_DOMAIN__",
                projectId: "__PROJECT_ID__",
                storageBucket: "__STORAGE_BUCKET__",
                messagingSenderId: "__MESSAGING_SENDER_ID__",
                appId: "__APP_ID__"
            };
        }

        let app, auth, db, user;
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let winnerAcknowledged = false;
        let audioCtx = null; // Audio Context

        let gameState = { players: [], rounds: [], active: false, champion: null };

        // --- AUDIO SYSTEM ---
        window.initAudio = function() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                document.getElementById('audioBtn').textContent = "Audio Activado ‚úÖ";
                document.getElementById('audioBtn').classList.remove('text-emerald-300');
                document.getElementById('audioBtn').classList.add('text-green-400');
                playSound('ping', 0.01); // Test sound silent
            } else if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playSound(type, vol = 0.1) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'ping') {
                // Sonido de golpe seco
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'win') {
                // Fanfarria simple
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(440, audioCtx.currentTime);
                osc.frequency.setValueAtTime(554, audioCtx.currentTime + 0.1); // C#
                osc.frequency.setValueAtTime(659, audioCtx.currentTime + 0.2); // E
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.6);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.6);
            }
        }

        // --- FIREBASE INIT ---
        async function initApp() {
            if (firebaseConfig.apiKey.startsWith("__")) {
                updateStatus("Falta Config (Local)", "text-orange-400");
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                const appId = firebaseConfig.projectId && !firebaseConfig.projectId.startsWith("__") ? firebaseConfig.projectId : 'ping-pong-app';
                window.DB_PATH_PREFIX = `artifacts/${appId}/public/data/tournaments`;
                await signInAnonymously(auth);
                updateStatus("Conectado", "text-emerald-400");
            } catch (error) {
                console.error(error);
                updateStatus("Error de Conexi√≥n", "text-red-500");
            }
        }

        function updateStatus(msg, colorClass) {
            const el = document.getElementById('connectionStatus');
            if(el) { el.innerHTML = `<i class="fas fa-wifi"></i> ${msg}`; el.className = `text-xs font-mono ${colorClass}`; }
        }

        // --- ROOMS ---
        window.createRoom = async function() {
            if (!auth.currentUser) return showToast("Conectando...", "error");
            initAudio(); // Try init audio on interaction
            const code = Math.random().toString(36).substring(2, 6).toUpperCase();
            const roomRef = doc(db, window.DB_PATH_PREFIX, code);
            try {
                await setDoc(roomRef, {
                    players: [], rounds: [], active: false, champion: null,
                    createdAt: new Date().toISOString(), creator: auth.currentUser.uid
                });
                enterRoom(code);
            } catch (e) { showToast("Error: " + e.message, "error"); }
        }

        window.joinRoom = function() {
            const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
            if (code.length < 2) return showToast("C√≥digo inv√°lido", "error");
            initAudio(); // Try init audio
            enterRoom(code);
        }

        function enterRoom(code) {
            if (unsubscribeRoom) unsubscribeRoom();
            currentRoomId = code;
            document.getElementById('lobbySection').classList.add('hidden');
            document.getElementById('roomDisplay').classList.remove('hidden');
            document.getElementById('roomCodeDisplay').textContent = code;
            
            unsubscribeRoom = onSnapshot(doc(db, window.DB_PATH_PREFIX, code), (snap) => {
                if (snap.exists()) {
                    gameState = snap.data();
                    syncUI();
                } else {
                    showToast("Sala no encontrada", "error");
                    exitRoom();
                }
            });
        }

        function exitRoom() {
            currentRoomId = null;
            document.getElementById('lobbySection').classList.remove('hidden');
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('bracketSection').classList.add('hidden');
            document.getElementById('roomDisplay').classList.add('hidden');
        }

        // --- UI SYNC ---
        function syncUI() {
            if (gameState.active) {
                document.getElementById('setupSection').classList.add('hidden');
                document.getElementById('bracketSection').classList.remove('hidden');
                renderBracket();
            } else {
                document.getElementById('bracketSection').classList.add('hidden');
                document.getElementById('setupSection').classList.remove('hidden');
                renderPlayerList();
            }

            // Champion Modal Logic
            const modal = document.getElementById('winnerAnnouncement');
            const btn = document.getElementById('showChampionBtn');
            if (gameState.champion) {
                btn.classList.remove('hidden');
                if (!winnerAcknowledged && modal.classList.contains('hidden')) {
                     modal.classList.remove('hidden');
                     document.getElementById('winnerText').textContent = `üèÜ ${gameState.champion} üèÜ`;
                     confetti({ particleCount: 150, spread: 100 });
                     playSound('win', 0.3);
                }
            } else {
                btn.classList.add('hidden');
                modal.classList.add('hidden');
                winnerAcknowledged = false;
            }
            
            // Update stats if modal is open
            if (!document.getElementById('statsModal').classList.contains('hidden')) {
                calculateAndRenderStats();
            }
        }

        // --- GAMEPLAY ---
        window.addPlayer = async function() {
            const name = document.getElementById('playerInput').value.trim();
            if (!name || gameState.players.includes(name)) return;
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { players: arrayUnion(name) });
            document.getElementById('playerInput').value = '';
            playSound('ping');
        }

        window.removePlayer = async function(idx) {
            const newP = [...gameState.players]; newP.splice(idx, 1);
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { players: newP });
        }

        window.startTournament = async function() {
            if (gameState.players.length < 2) return;
            const shuffled = [...gameState.players].sort(() => Math.random() - 0.5);
            const matches = [];
            while (shuffled.length > 0) {
                const p1 = shuffled.pop(); const p2 = shuffled.length > 0 ? shuffled.pop() : null;
                matches.push({ p1, p2, score1: 0, score2: 0, winner: p2 ? null : p1, isBye: !p2 });
            }
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { 
                rounds: [{ matches }], active: true, champion: null 
            });
            playSound('win', 0.2);
        }

        window.updateScore = async function(rIdx, mIdx, pNum, val) {
            const rounds = JSON.parse(JSON.stringify(gameState.rounds));
            const match = rounds[rIdx].matches[mIdx];
            if (pNum === 1) match.score1 = parseInt(val); else match.score2 = parseInt(val);
            
            // Optimistic UI update for sound responsiveness? 
            // Better just play sound immediately
            playSound('ping'); 
            
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { rounds });
        }

        window.finishMatch = async function(rIdx, mIdx) {
            const rounds = JSON.parse(JSON.stringify(gameState.rounds));
            const matches = rounds[rIdx].matches;
            const match = matches[mIdx];
            
            if (match.score1 === match.score2) return showToast("No empates", "error");
            match.winner = match.score1 > match.score2 ? match.p1 : match.p2;
            playSound('win');

            let champ = null;
            // Logic to advance round
            if (matches.every(m => m.winner)) {
                if (matches.length === 1) champ = match.winner;
                else if (!rounds[rIdx + 1]) {
                    const nextMatches = [];
                    const winners = matches.map(m => m.winner);
                    for (let i=0; i<winners.length; i+=2) {
                        const p1 = winners[i], p2 = winners[i+1] || null;
                        nextMatches.push({ p1, p2, score1: 0, score2: 0, winner: p2?null:p1, isBye: !p2 });
                    }
                    rounds.push({ matches: nextMatches });
                }
            }
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { rounds, champion: champ });
        }

        window.confirmReset = async function() {
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { active: false, rounds: [], champion: null });
            closeResetModal();
        }

        // --- STATS LOGIC ---
        window.showStatsModal = function() {
            document.getElementById('statsModal').classList.remove('hidden');
            calculateAndRenderStats();
        }
        window.closeStatsModal = function() {
            document.getElementById('statsModal').classList.add('hidden');
        }

        function calculateAndRenderStats() {
            const stats = {};
            // Init stats for all players
            gameState.players.forEach(p => {
                stats[p] = { name: p, played: 0, won: 0, diff: 0 };
            });

            // Process rounds
            gameState.rounds.forEach(round => {
                round.matches.forEach(m => {
                    if (m.isBye) return; // Ignorar byes
                    
                    // Contar jugados solo si hubo score o ganador
                    if (m.score1 > 0 || m.score2 > 0 || m.winner) {
                        if(stats[m.p1]) {
                            stats[m.p1].played++;
                            stats[m.p1].diff += (m.score1 - m.score2);
                        }
                        if(m.p2 && stats[m.p2]) {
                            stats[m.p2].played++;
                            stats[m.p2].diff += (m.score2 - m.score1);
                        }
                    }

                    if (m.winner) {
                        if(stats[m.winner]) stats[m.winner].won++;
                    }
                });
            });

            // Convert to array and sort
            const sortedStats = Object.values(stats).sort((a, b) => {
                if (a.won !== b.won) return b.won - a.won; // Mayor ganados primero
                return b.diff - a.diff; // Mayor diferencia de puntos
            });

            // Render
            const tbody = document.getElementById('statsTableBody');
            tbody.innerHTML = '';
            sortedStats.forEach((s, i) => {
                const isLeader = i === 0 && s.won > 0;
                const rowClass = isLeader ? 'bg-yellow-500/20 text-yellow-200' : 'border-b border-emerald-800/30 text-emerald-100';
                
                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td class="py-2 pl-2 font-mono text-emerald-500/70">${i + 1}</td>
                        <td class="py-2 flex items-center gap-2">
                            ${getAvatar(s.name)}
                            <span class="${isLeader ? 'font-bold' : ''}">${s.name} ${isLeader ? 'üëë' : ''}</span>
                        </td>
                        <td class="py-2 text-center font-mono">${s.played}</td>
                        <td class="py-2 text-center font-mono font-bold">${s.won}</td>
                        <td class="py-2 text-center font-mono text-xs ${s.diff > 0 ? 'text-green-400' : 'text-red-400'}">${s.diff > 0 ? '+' : ''}${s.diff}</td>
                    </tr>
                `;
            });
        }

        // --- HELPERS ---
        function getAvatar(name) {
            const initial = name.charAt(0).toUpperCase();
            return `<div class="w-6 h-6 rounded-full player-avatar flex items-center justify-center text-[10px] font-bold text-white shadow-sm">${initial}</div>`;
        }

        window.copyRoomCode = function() {
            const code = document.getElementById('roomCodeDisplay').textContent;
            navigator.clipboard.writeText(code).then(() => showToast("C√≥digo copiado!"));
        }

        window.toggleFullScreen = function() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        // UI Bindings
        window.handleEnter = (e) => { if(e.key === 'Enter') addPlayer(); };
        window.showResetModal = () => document.getElementById('resetModal').classList.remove('hidden');
        window.closeResetModal = () => document.getElementById('resetModal').classList.add('hidden');
        window.closeWinnerModal = () => { document.getElementById('winnerAnnouncement').classList.add('hidden'); winnerAcknowledged = true; };
        window.showWinnerModal = () => { winnerAcknowledged = false; document.getElementById('winnerAnnouncement').classList.remove('hidden'); };
        window.showToast = (msg, type) => {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-xl transition-all duration-300 z-[70] ${type==='error'?'bg-red-600':'bg-emerald-600'} text-white`;
            toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        };

        // RENDER BRACKET (Updated with avatars)
        function renderBracket() {
            const container = document.getElementById('roundsContainer'); container.innerHTML = '';
            gameState.rounds.forEach((r, rIdx) => {
                const roundDiv = document.createElement('div');
                roundDiv.className = "min-w-[85vw] md:min-w-[350px] flex flex-col gap-3 snap-center shrink-0 pb-4";
                roundDiv.innerHTML = `<h3 class="text-center font-bold text-emerald-400 bg-emerald-900/80 backdrop-blur-sm py-2 rounded mb-2 sticky top-0 z-10">Ronda ${rIdx + 1}</h3>`;
                
                r.matches.forEach((m, mIdx) => {
                    const done = m.winner !== null;
                    const p1W = m.winner === m.p1;
                    const p2W = m.winner === m.p2;
                    let html = `<div class="glass-panel rounded-lg p-3 border-l-4 ${done ? 'border-l-yellow-400' : 'border-l-emerald-500'} relative">`;
                    
                    if(m.isBye) {
                        html += `<div class="text-center py-4"><div class="font-bold text-white flex justify-center items-center gap-2">${getAvatar(m.p1)} ${m.p1}</div><div class="text-xs text-emerald-400 mt-1">BYE</div></div>`;
                    } else {
                        html += `
                        <div class="flex justify-between items-center mb-2 ${p1W ? 'text-yellow-400 font-bold' : 'text-white'}">
                            <span class="truncate w-32 flex items-center gap-2 text-sm">${getAvatar(m.p1)} ${m.p1}</span>
                            <input type="number" value="${m.score1}" onchange="updateScore(${rIdx},${mIdx},1,this.value)" ${done?'disabled':''} class="w-12 bg-emerald-900 border border-emerald-600 text-center rounded text-white h-9 text-lg focus:border-orange-400 outline-none">
                        </div>
                        <div class="flex justify-between items-center mt-2 ${p2W ? 'text-yellow-400 font-bold' : 'text-white'}">
                            <span class="truncate w-32 flex items-center gap-2 text-sm">${getAvatar(m.p2||'?')} ${m.p2||'?'}</span>
                            <input type="number" value="${m.score2}" onchange="updateScore(${rIdx},${mIdx},2,this.value)" ${done?'disabled':''} class="w-12 bg-emerald-900 border border-emerald-600 text-center rounded text-white h-9 text-lg focus:border-orange-400 outline-none">
                        </div>`;
                        if(!done && m.p2) html += `<button onclick="finishMatch(${rIdx},${mIdx})" class="w-full mt-3 bg-emerald-600 text-white font-bold py-2 rounded text-xs hover:bg-emerald-500 transition-colors">FINALIZAR</button>`;
                    }
                    html += `</div>`; roundDiv.innerHTML += html;
                });
                container.appendChild(roundDiv);
            });
        }

        function renderPlayerList() {
            const list = document.getElementById('playerList'); list.innerHTML = '';
            gameState.players.forEach((p, i) => {
                list.innerHTML += `
                    <li class="flex justify-between items-center bg-emerald-800/40 px-3 py-2 rounded border border-emerald-700/50 animate-fade-in">
                        <span class="text-white font-medium flex items-center gap-2">${getAvatar(p)} ${p}</span>
                        <button onclick="removePlayer(${i})" class="text-red-400 hover:bg-red-500/20 p-1 rounded"><i class="fas fa-times"></i></button>
                    </li>`;
            });
            document.getElementById('playerCount').textContent = `${gameState.players.length} Jugadores`;
            document.getElementById('startBtn').disabled = gameState.players.length < 2;
        }

        initApp();
    </script>
</body>
</html>