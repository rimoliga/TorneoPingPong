<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneo de Amigos - Live</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèì</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&family=Bangers&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a2e22;
            background-image: radial-gradient(#2d4a37 15%, transparent 16%), radial-gradient(#2d4a37 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            color: #ecfdf5;
            overscroll-behavior-y: none;
            user-select: none;
        }
        .comic-font { font-family: 'Bangers', cursive; letter-spacing: 2px; }
        .retro-font { font-family: 'Press Start 2P', cursive; }
        
        .glass-panel {
            background: rgba(16, 185, 129, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(16, 185, 129, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .animate-bounce-paddle { animation: bounce-paddle 2s infinite; }
        @keyframes bounce-paddle {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(10deg); }
        }

        .avatar-img { transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .avatar-img:hover { transform: scale(1.2) rotate(5deg); }
        
        .score-btn:active { transform: scale(0.98); background-color: rgba(255,255,255,0.05); }
        .score-btn.locked-add { opacity: 0.6; }
        
        .serve-ball {
            box-shadow: 0 0 10px #fff, 0 0 20px #fff;
            animation: pulse-ball 1s infinite;
        }
        @keyframes pulse-ball {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        
        @keyframes win-flash {
            0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); transform: scale(1); }
            50% { box-shadow: 0 0 20px 10px rgba(234, 179, 8, 0); transform: scale(1.05); }
            100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); transform: scale(1); }
        }
        .just-won {
            animation: win-flash 1s ease-out;
            z-index: 20;
            border-color: #fbbf24 !important;
        }
        
        .badge-status { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-new { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid rgba(16, 185, 129, 0.4); }
        .status-live { background: rgba(245, 158, 11, 0.2); color: #fcd34d; border: 1px solid rgba(245, 158, 11, 0.4); animation: pulse-border 2s infinite; }
        .status-done { background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.4); }
        @keyframes pulse-border { 0% { border-color: rgba(245, 158, 11, 0.4); } 50% { border-color: rgba(245, 158, 11, 1); } 100% { border-color: rgba(245, 158, 11, 0.4); } }

        .featured-card {
            background: linear-gradient(135deg, rgba(6, 78, 59, 0.9) 0%, rgba(16, 185, 129, 0.2) 100%);
            border: 1px solid #fcd34d;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
        }

        #varOverlay {
            background: rgba(0, 0, 0, 0.85);
            border-bottom: 4px solid #ef4444;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .scanline {
            width: 100%; height: 100%; z-index: 60;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(0,0,0,0) 100%);
            position: absolute; top: 0; left: 0;
            animation: scanline 3s linear infinite;
            pointer-events: none;
        }
        @keyframes scanline { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }

        .me-highlight {
            color: #fcd34d !important; /* Yellow text */
            font-weight: bold;
            text-shadow: 0 0 10px rgba(252, 211, 77, 0.5);
        }
        
        .bracket-medal { font-size: 0.6em; margin-left: 2px; filter: drop-shadow(0 0 2px gold); }
        .locked-identity { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        .clickable-name:hover { color: #fcd34d; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-2 md:p-4 overflow-x-hidden transition-colors duration-500">

    <div class="fixed top-0 right-0 bg-emerald-900/80 backdrop-blur text-emerald-400 text-[10px] px-2 py-1 z-50 font-mono border-b border-l border-emerald-500/30 rounded-bl-lg flex gap-2 items-center">
        <span>v11.2 (Final Fixes)</span>
        <button onclick="toggleFullScreen()" class="hover:text-white"><i class="fas fa-expand"></i></button>
    </div>

    <header class="w-full max-w-3xl text-center mb-4 mt-2 relative flex flex-col items-center">
        <div class="flex justify-center items-center gap-3 mb-2 w-full relative">
            <!-- FIX: Removed 'currentUserIdentity' from onclick to use internal scope variable -->
            <button id="profileBtn" onclick="showProfileModal()" class="hidden absolute left-0 top-1/2 transform -translate-y-1/2 bg-emerald-900/80 px-2 py-1 rounded-lg border border-emerald-500/30 hover:bg-emerald-800 transition-colors z-20">
                <div class="flex flex-col items-center">
                    <div id="headerAvatar" class="w-6 h-6 mb-[-4px]"></div>
                    <span class="text-[8px] text-emerald-200 uppercase font-bold">Perfil</span>
                </div>
            </button>

            <i class="fas fa-table-tennis text-2xl md:text-4xl text-orange-400 animate-bounce-paddle"></i>
            <h1 id="mainTitle" class="text-3xl md:text-5xl text-white comic-font text-shadow-md leading-tight tracking-wider transform -rotate-1">
                PING PONG<br><span class="text-emerald-400 text-xl md:text-3xl">ONLINE</span>
            </h1>
        </div>
        
        <div id="connectionStatus" class="text-xs font-mono text-yellow-500 animate-pulse">
            <i class="fas fa-wifi"></i> Conectando...
        </div>
        
        <div id="roomDisplay" class="hidden mt-2 group cursor-pointer transition-all active:scale-95" onclick="copyRoomCode()">
            <div class="bg-emerald-900/80 px-4 py-1 rounded-full border border-emerald-500/50 inline-flex items-center gap-2">
                <span class="text-emerald-400 text-xs uppercase tracking-wider">SALA:</span>
                <span id="roomCodeDisplay" class="text-white font-bold font-mono text-lg tracking-widest">----</span>
                <i class="fas fa-copy text-emerald-600 group-hover:text-white transition-colors text-xs"></i>
            </div>
            <div class="text-[10px] text-emerald-500/50 mt-1 opacity-0 group-hover:opacity-100 transition-opacity">Click para copiar</div>
        </div>
        <div id="welcomeMsg" class="hidden text-yellow-300 font-bold text-sm mt-1 animate-fade-in">Hola, <span id="userIdName">Jugador</span> üëã</div>
    </header>

    <!-- 1. LOBBY -->
    <div id="lobbySection" class="w-full max-w-sm glass-panel rounded-xl p-6 mb-8 text-center transition-all duration-500">
        <h2 class="text-xl font-bold text-white mb-4">üèÜ Configurar Torneo</h2>
        <div class="space-y-4 mb-6 text-left">
            <div>
                <label class="text-xs text-emerald-400 ml-1 uppercase font-bold">Nombre del Torneo</label>
                <input type="text" id="tourneyNameInput" value="Torneo de Amigos üèÜ" maxlength="25" class="w-full bg-emerald-900/50 border border-emerald-500/50 rounded-lg px-3 py-2 text-white font-bold placeholder-emerald-700 focus:outline-none focus:ring-2 focus:ring-orange-400 text-center text-lg">
            </div>
            <div class="flex gap-4">
                <div class="flex-1">
                    <label class="text-xs text-emerald-400 ml-1 uppercase font-bold">Puntos por Set</label>
                    <div class="relative">
                        <input type="number" id="pointsInput" value="11" min="1" max="99" class="w-full bg-emerald-900/50 border border-emerald-500/50 rounded-lg px-3 py-2 text-white text-center font-mono font-bold focus:ring-2 focus:ring-orange-400">
                        <div class="absolute right-2 top-2 text-emerald-500/50 text-xs pointer-events-none">PTS</div>
                    </div>
                </div>
            </div>
        </div>
        <button onclick="createRoom()" class="w-full bg-orange-500 hover:bg-orange-400 text-white font-bold py-3 px-4 rounded-lg shadow-lg mb-6 transition-transform active:scale-95 flex items-center justify-center gap-2"><i class="fas fa-plus-circle"></i> CREAR SALA</button>
        <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-emerald-700"></div><span class="flex-shrink-0 mx-4 text-emerald-500 text-xs">O UNIRSE A UNA</span><div class="flex-grow border-t border-emerald-700"></div></div>
        <div class="mt-4 flex gap-2">
            <input type="text" id="joinCodeInput" placeholder="C√ìDIGO" maxlength="4" class="flex-1 bg-emerald-900/50 border border-emerald-600 rounded-lg px-4 py-2 text-white text-center font-mono uppercase placeholder-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-400 h-12">
            <button onclick="joinRoom()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-4 rounded-lg transition-colors h-12">ENTRAR</button>
        </div>
        <div class="mt-6 pt-4 border-t border-emerald-800/50">
            <button onclick="initAudio()" id="audioBtn" class="text-xs bg-emerald-900/50 hover:bg-emerald-800 px-3 py-1 rounded text-emerald-300 border border-emerald-700 w-full"><i class="fas fa-volume-up mr-1"></i> Activar Sonidos</button>
        </div>
    </div>

    <!-- 2. IDENTITY SELECTION -->
    <div id="identitySection" class="w-full max-w-sm glass-panel rounded-xl p-6 mb-8 hidden mx-2 text-center">
        <h2 class="text-xl font-bold text-white mb-2">¬øQui√©n eres?</h2>
        <p class="text-emerald-400/70 text-xs mb-6">Selecciona tu nombre para jugar</p>
        
        <!-- ADMIN ADD PANEL -->
        <div id="adminAddPanel" class="hidden mb-4 bg-emerald-900/40 p-3 rounded-lg border border-yellow-500/30">
            <div class="text-[10px] text-yellow-400 font-bold uppercase mb-2 text-left"><i class="fas fa-crown mr-1"></i> Inscribir Participantes</div>
            <div class="flex gap-2 flex-col">
                <div class="flex gap-2">
                    <input type="text" id="adminAddInput" placeholder="Nombre..." class="w-full bg-emerald-950/50 border border-emerald-600 rounded-lg px-3 py-1 text-sm text-white focus:outline-none focus:ring-1 focus:ring-emerald-400">
                    <button onclick="adminQuickAdd()" class="bg-emerald-500 hover:bg-emerald-400 text-emerald-950 font-bold px-3 rounded-lg shadow"><i class="fas fa-plus"></i></button>
                </div>
                <input type="text" id="adminNickInput" placeholder="Apodo (Opcional)" class="w-full bg-emerald-950/30 border-b border-emerald-600/30 px-3 py-1 text-xs text-emerald-200 focus:outline-none focus:border-emerald-400">
            </div>
        </div>

        <div id="identityList" class="space-y-2 mb-6 max-h-48 overflow-y-auto"></div>
        
        <div class="relative flex py-2 items-center"><div class="flex-grow border-t border-emerald-700"></div><span class="flex-shrink-0 mx-4 text-emerald-500 text-xs">O SOY NUEVO</span><div class="flex-grow border-t border-emerald-700"></div></div>
        <div class="flex gap-2 mt-4 flex-col">
            <input type="text" id="newIdentityInput" placeholder="Tu Nombre..." class="w-full bg-emerald-900/50 border border-emerald-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-400">
            <div class="flex gap-2">
                <input type="text" id="newIdentityNick" placeholder="Apodo (Opcional)" class="flex-1 bg-emerald-950/50 border border-emerald-600/50 rounded-lg px-4 py-2 text-sm text-emerald-200 focus:outline-none focus:ring-1 focus:ring-emerald-400">
                <button onclick="registerNewIdentity()" class="bg-emerald-500 hover:bg-emerald-400 text-emerald-950 font-bold px-4 rounded-lg shadow-lg"><i class="fas fa-check"></i></button>
            </div>
        </div>
    </div>

    <!-- 3. SETUP SECTION -->
    <div id="setupSection" class="w-full max-w-md glass-panel rounded-xl p-4 md:p-6 mb-8 hidden mx-2">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg md:text-xl font-bold text-emerald-300 flex items-center gap-2"><i class="fas fa-users"></i> Jugadores</h2>
            <span class="text-xs text-emerald-500 bg-emerald-900/40 px-2 py-1 rounded border border-emerald-500/20" id="rulesDisplay">A 11 Puntos</span>
        </div>
        
        <!-- Add Player Form -->
        <div class="flex gap-2 mb-4">
            <div class="flex-1">
                <input type="text" id="playerInput" placeholder="Agregar otro jugador..." class="w-full bg-emerald-900/50 border border-emerald-600 rounded-t-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-400" onkeypress="handleEnter(event)">
                <input type="text" id="playerNickInput" placeholder="Apodo (Opcional)" class="w-full bg-emerald-950/50 border-x border-b border-emerald-600/50 rounded-b-lg px-4 py-1 text-sm text-emerald-200 focus:outline-none focus:ring-1 focus:ring-emerald-400" onkeypress="handleEnter(event)">
            </div>
            <button onclick="addPlayer()" class="bg-emerald-500 hover:bg-emerald-400 text-emerald-950 font-bold py-2 px-4 rounded-lg shadow-lg h-full self-start"><i class="fas fa-plus"></i></button>
        </div>

        <ul id="playerList" class="space-y-2 mb-6 max-h-60 overflow-y-auto pr-1"></ul>
        <div class="flex justify-between items-center pt-4 border-t border-emerald-700/50">
            <span class="text-emerald-400 text-sm font-mono" id="playerCount">0 Jugadores</span>
            <button onclick="startTournament()" id="startBtn" disabled class="bg-orange-500 hover:bg-orange-400 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-6 rounded-lg shadow-lg active:translate-y-1 transition-all">SORTEAR <i class="fas fa-dice ml-2"></i></button>
        </div>
    </div>

    <!-- 4. DASHBOARD SECTION -->
    <div id="bracketSection" class="w-full max-w-6xl hidden flex flex-col h-[80vh]">
        <div id="featuredMatchContainer" class="w-full mb-4 hidden px-2"></div>
        <div class="flex justify-between items-center mb-4 glass-panel p-3 rounded-lg mx-2 shrink-0">
            <h2 class="text-lg font-bold text-white"><i class="fas fa-trophy text-yellow-400 mr-2"></i> Llave</h2>
            <div class="flex gap-2">
                <button onclick="showStatsModal()" class="bg-emerald-600/30 text-emerald-200 border border-emerald-500/50 rounded px-3 py-1 text-xs hover:bg-emerald-600/50 transition-colors"><i class="fas fa-list-ol"></i> Tabla</button>
                <button id="showChampionBtn" onclick="showWinnerModal()" class="hidden bg-yellow-500/20 text-yellow-400 border border-yellow-500/50 rounded px-3 py-1 text-xs hover:bg-yellow-500/40 transition-colors font-bold"><i class="fas fa-crown"></i></button>
                <button id="resetBtn" onclick="showResetModal()" class="hidden text-red-400 border border-red-500/30 rounded px-3 py-1 text-xs hover:bg-red-500/10"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>
        <div id="roundsContainer" class="flex flex-row gap-4 overflow-x-auto pb-8 snap-x snap-mandatory px-4 w-full no-scrollbar h-full items-start"></div>
    </div>

    <!-- MODALS -->
    <!-- LIVE MATCH MODAL -->
    <div id="liveMatchModal" class="hidden fixed inset-0 z-[60] bg-black text-white flex flex-col">
        <div class="flex justify-between items-center p-4 bg-emerald-900/50 border-b border-emerald-500/30">
            <button onclick="closeLiveMatch()" class="text-emerald-400 hover:text-white flex items-center gap-2"><i class="fas fa-arrow-left"></i> <span class="text-xs font-bold">VOLVER</span></button>
            <button onclick="triggerVar()" class="bg-blue-600/30 hover:bg-blue-500/50 border border-blue-500/50 text-blue-200 px-3 py-1 rounded text-xs font-bold"><i class="fas fa-tv mr-1"></i> VAR</button>
        </div>
        <div class="flex-1 flex flex-col md:flex-row relative">
            <div id="liveAreaP1" class="flex-1 relative flex flex-col items-center justify-center border-b md:border-b-0 md:border-r border-emerald-700/30 score-btn transition-colors cursor-pointer select-none" onclick="liveScore(1, 1)">
                <div id="liveP1Serve" class="absolute top-4 right-4 text-white hidden"><div class="w-4 h-4 rounded-full bg-white serve-ball"></div></div>
                <div id="liveP1Avatar" class="transform scale-150 mb-4 pointer-events-none"></div>
                <h2 id="liveP1Name" class="text-xl md:text-3xl font-bold text-emerald-200 mb-1 pointer-events-none">Player 1</h2>
                <div id="liveP1Nick" class="text-xs text-emerald-400/70 mb-2 font-bold uppercase tracking-wider pointer-events-none"></div>
                <div id="liveP1Score" class="text-[8rem] md:text-[10rem] font-bold leading-none font-mono pointer-events-none">0</div>
                <button onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="event.stopPropagation(); liveScore(1, -1)" class="absolute bottom-4 left-4 w-12 h-12 rounded-full border-2 border-red-500/30 text-red-400 flex items-center justify-center hover:bg-red-500/20 bg-black/20 z-20 active:scale-90 transition-transform font-bold text-xl">-</button>
            </div>
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10 pointer-events-none"><div class="bg-black/50 backdrop-blur-md px-4 py-1 rounded-full border border-white/10 text-xs font-bold text-white/50">VS</div></div>
            <div id="liveAreaP2" class="flex-1 relative flex flex-col items-center justify-center score-btn transition-colors cursor-pointer select-none" onclick="liveScore(2, 1)">
                <div id="liveP2Serve" class="absolute top-4 left-4 text-white hidden"><div class="w-4 h-4 rounded-full bg-white serve-ball"></div></div>
                <div id="liveP2Avatar" class="transform scale-150 mb-4 pointer-events-none"></div>
                <h2 id="liveP2Name" class="text-xl md:text-3xl font-bold text-yellow-200 mb-1 pointer-events-none">Player 2</h2>
                <div id="liveP2Nick" class="text-xs text-yellow-400/70 mb-2 font-bold uppercase tracking-wider pointer-events-none"></div>
                <div id="liveP2Score" class="text-[8rem] md:text-[10rem] font-bold leading-none font-mono pointer-events-none">0</div>
                <button onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()" onclick="event.stopPropagation(); liveScore(2, -1)" class="absolute bottom-4 right-4 w-12 h-12 rounded-full border-2 border-red-500/30 text-red-400 flex items-center justify-center hover:bg-red-500/20 bg-black/20 z-20 active:scale-90 transition-transform font-bold text-xl">-</button>
            </div>
        </div>
        <div class="bg-black/90 p-4 border-t border-emerald-800/50">
            <div class="text-center text-xs text-emerald-500 uppercase font-bold mb-2">Predicciones del P√∫blico</div>
            <div class="flex justify-between items-center gap-2">
                <button id="voteBtnP1" onclick="voteFor(1)" class="bg-emerald-900/50 text-emerald-400 text-xs px-3 py-2 rounded hover:bg-emerald-700/50 border border-emerald-700/50 hidden">Votar P1</button>
                <div class="flex-1 h-4 bg-gray-800 rounded-full overflow-hidden relative">
                    <div id="barVoteP1" class="h-full bg-emerald-500 transition-all duration-500" style="width: 50%"></div>
                    <div class="absolute inset-0 flex justify-between px-2 items-center text-[9px] font-bold text-black mix-blend-overlay">
                        <span id="textVoteP1">50%</span><span id="textVoteP2">50%</span>
                    </div>
                </div>
                <button id="voteBtnP2" onclick="voteFor(2)" class="bg-yellow-900/50 text-yellow-400 text-xs px-3 py-2 rounded hover:bg-yellow-700/50 border border-yellow-700/50 hidden">Votar P2</button>
            </div>
        </div>
        <div id="liveFinishBtnContainer" class="hidden p-6 bg-emerald-900/80 border-t border-emerald-500/30 flex justify-center">
            <button onclick="finishLiveMatch()" class="w-full max-w-md bg-green-500 hover:bg-green-400 text-green-900 font-bold py-4 rounded-xl text-xl shadow-[0_0_20px_rgba(34,197,94,0.5)] animate-pulse"><i class="fas fa-check-circle mr-2"></i> FINALIZAR PARTIDO</button>
        </div>
    </div>

    <div id="varOverlay" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-[100] w-11/12 max-w-md bg-black/90 rounded-lg overflow-hidden shadow-2xl border-2 border-blue-500/50 pointer-events-none">
        <div class="scanline"></div>
        <div class="p-4 flex items-center gap-4"><div class="text-3xl animate-pulse">üì∫</div><div class="flex-1"><div class="text-blue-400 font-black tracking-widest text-lg">VAR REVIEW</div><div id="varStatusText" class="text-sm font-mono text-white">ANALIZANDO JUGADA...</div></div></div>
    </div>

    <div id="notificationOverlay" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-orange-600 p-8 rounded-xl shadow-[0_0_50px_orange] text-center border-4 border-yellow-400">
            <div class="text-6xl mb-4 animate-bounce">üèì</div>
            <h2 class="text-4xl font-black text-white comic-font mb-2">¬°TE TOCA!</h2>
            <p class="text-orange-100 font-bold text-xl mb-6">Es tu turno de jugar</p>
            <button onclick="closeNotification()" class="bg-white text-orange-600 font-black px-8 py-4 rounded-full text-xl hover:bg-gray-100 shadow-lg transform active:scale-95 transition-transform w-full">¬°VOY!</button>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profileModal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
        <div class="glass-panel rounded-xl w-full max-w-sm p-6 relative border border-emerald-500/50">
            <button onclick="closeProfileModal()" class="absolute top-4 right-4 text-emerald-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <div class="flex flex-col items-center mb-4">
                <div id="profileAvatarLarge" class="mb-2"></div>
                <h2 id="profileName" class="text-2xl font-bold text-white">Nombre</h2>
                <div id="profileNick" class="text-sm text-emerald-400 italic"></div>
            </div>
            <div class="flex border-b border-emerald-700 mb-4">
                <button onclick="switchProfileTab('current')" id="tabCurrent" class="flex-1 py-2 text-xs font-bold text-emerald-400 border-b-2 border-emerald-400">TORNEO ACTUAL</button>
                <button onclick="switchProfileTab('global')" id="tabGlobal" class="flex-1 py-2 text-xs font-bold text-emerald-600 hover:text-emerald-400 border-b-2 border-transparent">HISTORIAL</button>
            </div>
            <div id="statsCurrent" class="stats-view">
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <div class="bg-emerald-900/50 rounded p-2 text-center border border-emerald-500/30"><div id="statPJ" class="text-xl font-bold text-white">0</div><div class="text-[10px] text-emerald-400 uppercase">Jugados</div></div>
                    <div class="bg-emerald-900/50 rounded p-2 text-center border border-emerald-500/30"><div id="statPG" class="text-xl font-bold text-yellow-400">0</div><div class="text-[10px] text-emerald-400 uppercase">Ganados</div></div>
                    <div class="bg-emerald-900/50 rounded p-2 text-center border border-emerald-500/30"><div id="statWinRate" class="text-xl font-bold text-blue-400">0%</div><div class="text-[10px] text-emerald-400 uppercase">Win Rate</div></div>
                </div>
                <h3 class="text-xs text-emerald-500 uppercase font-bold mb-2 border-b border-emerald-800 pb-1">Medallas del Torneo</h3>
                <div id="badgesContainerCurrent" class="grid grid-cols-4 gap-2"></div>
            </div>
            <div id="statsGlobal" class="stats-view hidden">
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <div class="bg-indigo-900/50 rounded p-2 text-center border border-indigo-500/30"><div id="gStatPJ" class="text-xl font-bold text-white">0</div><div class="text-[10px] text-indigo-300 uppercase">Total PJ</div></div>
                    <div class="bg-indigo-900/50 rounded p-2 text-center border border-indigo-500/30"><div id="gStatWins" class="text-xl font-bold text-yellow-400">0</div><div class="text-[10px] text-indigo-300 uppercase">Total PG</div></div>
                    <div class="bg-indigo-900/50 rounded p-2 text-center border border-indigo-500/30"><div id="gStatChamp" class="text-xl font-bold text-purple-400">0</div><div class="text-[10px] text-indigo-300 uppercase">Copas</div></div>
                </div>
                <h3 class="text-xs text-indigo-400 uppercase font-bold mb-2 border-b border-indigo-900 pb-1">Logros Hist√≥ricos</h3>
                <div id="badgesContainerGlobal" class="grid grid-cols-4 gap-2"></div>
            </div>
        </div>
    </div>

    <div id="statsModal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
        <div class="glass-panel rounded-xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-emerald-700/50 flex justify-between items-center"><h3 class="text-xl font-bold text-white"><i class="fas fa-chart-line text-emerald-400 mr-2"></i> Tabla de Posiciones</h3><button onclick="closeStatsModal()" class="text-emerald-400 hover:text-white"><i class="fas fa-times text-xl"></i></button></div>
            <div class="overflow-y-auto p-4"><table class="w-full text-left border-collapse"><thead><tr class="text-emerald-500 text-xs uppercase border-b border-emerald-700"><th class="py-2 pl-2">#</th><th class="py-2">Jugador</th><th class="py-2 text-center">PJ</th><th class="py-2 text-center">PG</th><th class="py-2 text-center">DIF</th></tr></thead><tbody id="statsTableBody" class="text-sm"></tbody></table></div>
        </div>
    </div>

    <div id="winnerAnnouncement" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="glass-panel p-8 rounded-2xl border-2 border-yellow-400 animate-pulse text-center max-w-sm w-full shadow-[0_0_50px_rgba(234,179,8,0.5)]">
            <h3 class="text-2xl text-yellow-300 font-bold mb-2">¬°CAMPE√ìN!</h3>
            <div class="flex justify-center my-6"><div id="winnerAvatarLarge" class="transform scale-150"></div></div>
            <div class="text-4xl font-bold text-white mb-6 comic-font" id="winnerText">NOMBRE</div>
            <div class="flex flex-col gap-3 w-full">
                <button onclick="closeWinnerModal(); showStatsModal();" class="bg-transparent border border-yellow-500/50 text-yellow-200 hover:bg-yellow-500/10 font-bold py-3 px-8 rounded-full w-full transition-colors">Ver Tabla Final</button>
                <button id="winnerResetBtn" onclick="confirmReset()" class="hidden bg-yellow-500 text-yellow-900 font-bold py-3 px-8 rounded-full w-full hover:bg-yellow-400 transition-colors shadow-lg">Nuevo Torneo</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-[90] pointer-events-none"></div>
    <div id="resetModal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-[70] backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl max-w-sm w-full mx-4 text-center border border-red-500/30">
            <h3 class="text-xl font-bold text-white mb-2">¬øReiniciar?</h3>
            <p class="text-emerald-200/70 mb-6">Se archivar√° el torneo actual en el historial.</p>
            <div class="flex gap-3 justify-center"><button onclick="closeResetModal()" class="px-4 py-2 rounded-lg text-emerald-200 border border-emerald-500/30">Cancelar</button><button onclick="confirmReset()" class="px-4 py-2 rounded-lg bg-red-600 text-white font-bold">S√≠, Guardar y Reiniciar</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        try { if (typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config); else throw new Error("No config"); } 
        catch (e) { firebaseConfig = { apiKey: "__API_KEY__", authDomain: "__AUTH_DOMAIN__", projectId: "__PROJECT_ID__", storageBucket: "__STORAGE_BUCKET__", messagingSenderId: "__MESSAGING_SENDER_ID__", appId: "__APP_ID__" }; }

        let app, auth, db;
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let winnerAcknowledged = false;
        let audioCtx = null; 
        let liveMatchIndices = null; 
        let previousRounds = null;
        let lastVarTime = 0;
        let currentUserIdentity = null;
        let notifiedMatches = new Set();
        let clientUUID = localStorage.getItem('p_pong_client_id') || crypto.randomUUID();
        localStorage.setItem('p_pong_client_id', clientUUID);

        let gameState = { tournamentName: "Torneo", targetScore: 11, players: [], playerMeta: {}, claims: {}, rounds: [], votes: {}, varTrigger: 0, active: false, champion: null, globalStats: {} };

        // --- UTILS DECLARATIONS ---
        function getAvatar(name, size=24) { const seed = name.replace(/\s/g, ''); const url = `https://api.dicebear.com/7.x/adventurer-neutral/svg?seed=${seed}&backgroundColor=transparent`; return `<img src="${url}" width="${size}" height="${size}" class="rounded-full bg-white/10 avatar-img" alt="${name}">`; }
        
        function showToast(msg, type) { 
            const toast = document.getElementById('toast'); toast.textContent = msg; toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-xl transition-all duration-300 z-[90] ${type==='error'?'bg-red-600':'bg-emerald-600'} text-white`; toast.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000); 
        }

        function playSound(type, vol = 0.1) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            if (type === 'ping') { osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.start(); osc.stop(audioCtx.currentTime + 0.1); } 
            else if (type === 'win') { osc.type = 'triangle'; osc.frequency.setValueAtTime(440, audioCtx.currentTime); osc.frequency.setValueAtTime(554, audioCtx.currentTime + 0.1); osc.frequency.setValueAtTime(659, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.6); osc.start(); osc.stop(audioCtx.currentTime + 0.6); } 
            else if (type === 'var') { const buf = audioCtx.createBuffer(1, audioCtx.sampleRate*2, audioCtx.sampleRate); const d = buf.getChannelData(0); for(let i=0;i<buf.length;i++) d[i]=Math.random()*2-1; const n=audioCtx.createBufferSource(); n.buffer=buf; const g=audioCtx.createGain(); g.gain.setValueAtTime(0.05, audioCtx.currentTime); n.connect(g); g.connect(audioCtx.destination); n.start(); }
            else if (type === 'notify') { osc.type = 'square'; osc.frequency.setValueAtTime(880, audioCtx.currentTime); osc.frequency.setValueAtTime(880, audioCtx.currentTime + 0.1); osc.frequency.setValueAtTime(1100, audioCtx.currentTime + 0.2); gain.gain.setValueAtTime(vol, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.5); osc.start(); osc.stop(audioCtx.currentTime + 0.5); }
        }

        // EXPOSE TO WINDOW
        window.getAvatar = getAvatar;
        window.showToast = showToast;
        window.playSound = playSound;

        window.initAudio = function() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const btn = document.getElementById('audioBtn');
                if(btn) { btn.innerHTML = "<i class='fas fa-check'></i> Audio Activado"; btn.classList.replace('text-emerald-300', 'text-green-400'); }
                playSound('ping', 0.01);
            } else if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        async function initApp() {
            if (firebaseConfig.apiKey.startsWith("__")) { updateStatus("Falta Config", "text-orange-400"); return; }
            try {
                app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app);
                const appId = firebaseConfig.projectId && !firebaseConfig.projectId.startsWith("__") ? firebaseConfig.projectId : 'ping-pong-app';
                window.DB_PATH_PREFIX = `artifacts/${appId}/public/data/tournaments`;
                await signInAnonymously(auth);
                updateStatus("Conectado", "text-emerald-400");
            } catch (error) { console.error(error); updateStatus("Error", "text-red-500"); }
        }
        function updateStatus(msg, colorClass) { const el = document.getElementById('connectionStatus'); if(el) { el.innerHTML = `<i class="fas fa-wifi"></i> ${msg}`; el.className = `text-xs font-mono ${colorClass}`; } }

        function checkIdentity() {
            const storedName = localStorage.getItem(`p_pong_identity_${currentRoomId}`);
            if (storedName && gameState.players.includes(storedName)) { setIdentity(storedName); return true; }
            document.getElementById('identitySection').classList.remove('hidden');
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('bracketSection').classList.add('hidden');
            if(auth.currentUser && gameState.creator === auth.currentUser.uid) document.getElementById('adminAddPanel').classList.remove('hidden');
            else document.getElementById('adminAddPanel').classList.add('hidden');
            const list = document.getElementById('identityList'); list.innerHTML = '';
            gameState.players.forEach(p => {
                const isClaimed = gameState.claims && gameState.claims[p] && gameState.claims[p] !== clientUUID;
                const lockStyle = isClaimed ? 'opacity-50 cursor-not-allowed grayscale' : 'hover:bg-emerald-700/50 cursor-pointer';
                const icon = isClaimed ? '<i class="fas fa-lock text-red-400"></i>' : getAvatar(p, 32);
                list.innerHTML += `<button onclick="claimIdentity('${p}')" ${isClaimed ? 'disabled' : ''} class="w-full flex items-center gap-3 p-3 bg-emerald-800/30 rounded-lg border border-emerald-600/30 transition-colors text-left ${lockStyle}">${icon}<span class="font-bold text-white">${p} ${isClaimed ? '(Ocupado)' : ''}</span></button>`;
            });
            return false;
        }

        window.adminQuickAdd = async function() {
            const name = document.getElementById('adminAddInput').value.trim(); const nick = document.getElementById('adminNickInput').value.trim();
            if (!name) return showToast("Escribe un nombre", "error"); 
            if (gameState.players.includes(name)) return showToast("Nombre ocupado", "error"); 
            const updateData = { players: arrayUnion(name) };
            if(nick) updateData[`playerMeta.${name}`] = { nickname: nick };
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), updateData);
            document.getElementById('adminAddInput').value = ''; document.getElementById('adminNickInput').value = ''; playSound('ping');
        }

        window.claimIdentity = async function(name) {
            localStorage.setItem(`p_pong_identity_${currentRoomId}`, name); setIdentity(name);
            const updateData = {}; updateData[`claims.${name}`] = clientUUID;
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), updateData); syncUI();
        }

        window.registerNewIdentity = async function() { 
            const name = document.getElementById('newIdentityInput').value.trim(); const nick = document.getElementById('newIdentityNick').value.trim();
            if (!name) return showToast("Escribe un nombre", "error"); 
            if (gameState.players.includes(name)) return showToast("Nombre ocupado", "error"); 
            const updateData = { players: arrayUnion(name) };
            if(nick) updateData[`playerMeta.${name}`] = { nickname: nick };
            updateData[`claims.${name}`] = clientUUID;
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), updateData); 
            localStorage.setItem(`p_pong_identity_${currentRoomId}`, name); setIdentity(name);
        }
        
        function setIdentity(name) { 
            currentUserIdentity = name; 
            document.getElementById('identitySection').classList.add('hidden'); 
            document.getElementById('welcomeMsg').classList.remove('hidden'); 
            document.getElementById('userIdName').textContent = name; 
            document.getElementById('profileBtn').classList.remove('hidden');
            document.getElementById('headerAvatar').innerHTML = getAvatar(name, 24);
        }

        window.switchProfileTab = function(tab) {
            const cur = document.getElementById('statsCurrent'); const glob = document.getElementById('statsGlobal');
            const btnC = document.getElementById('tabCurrent'); const btnG = document.getElementById('tabGlobal');
            if(tab === 'current') { cur.classList.remove('hidden'); glob.classList.add('hidden'); btnC.classList.add('text-emerald-400', 'border-emerald-400'); btnC.classList.remove('text-emerald-600', 'border-transparent'); btnG.classList.remove('text-emerald-400', 'border-emerald-400'); btnG.classList.add('text-emerald-600', 'border-transparent'); }
            else { cur.classList.add('hidden'); glob.classList.remove('hidden'); btnG.classList.add('text-emerald-400', 'border-emerald-400'); btnG.classList.remove('text-emerald-600', 'border-transparent'); btnC.classList.remove('text-emerald-400', 'border-emerald-400'); btnC.classList.add('text-emerald-600', 'border-transparent'); }
        }

        window.showProfileModal = function(playerName) {
            // FIX: Use passed playerName OR fallback to current user
            const p = playerName || currentUserIdentity;
            if (!p) return; // Safety check

            document.getElementById('profileName').textContent = p;
            document.getElementById('profileNick').textContent = gameState.playerMeta[p]?.nickname || "";
            document.getElementById('profileAvatarLarge').innerHTML = getAvatar(p, 80);
            let played=0, won=0, streak=0, currentStreak=0, wallWins=0;
            const target = gameState.targetScore || 11;
            gameState.rounds.forEach(r => { r.matches.forEach(m => { if(m.isBye) return; if((m.score1>0 || m.score2>0) && (m.p1===p || m.p2===p)) played++; if(m.winner === p) { won++; currentStreak++; if(currentStreak>streak) streak=currentStreak; const oppScore = m.p1 === p ? m.score2 : m.score1; if(oppScore < (target/2)) wallWins++; } else if(m.winner && (m.p1===p || m.p2===p)) currentStreak=0; }); });
            document.getElementById('statPJ').textContent = played; document.getElementById('statPG').textContent = won; document.getElementById('statWinRate').textContent = played > 0 ? Math.round((won/played)*100)+'%' : '0%';
            const gStats = (gameState.globalStats && gameState.globalStats[p]) ? gameState.globalStats[p] : { played: 0, won: 0, tourneys: 0 };
            document.getElementById('gStatPJ').textContent = gStats.played; document.getElementById('gStatWins').textContent = gStats.won; document.getElementById('gStatChamp').textContent = gStats.tourneys;
            renderBadges(p, played, won, streak, wallWins, gStats);
            window.switchProfileTab('current');
            document.getElementById('profileModal').classList.remove('hidden');
        }
        window.closeProfileModal = function() { document.getElementById('profileModal').classList.add('hidden'); }

        function renderBadges(p, played, won, streak, wallWins, gStats) {
            const cBadges = [ { icon: 'üî•', name: 'On Fire', desc: 'Racha 2+', check: () => streak >= 2 }, { icon: 'üõ°Ô∏è', name: 'Muro', desc: 'Rival <50%', check: () => wallWins >= 1 }, { icon: '‚öîÔ∏è', name: '1ra Sangre', desc: 'Ganar 1', check: () => won >= 1 }, { icon: 'üî∞', name: 'Debut', desc: 'Jugar 1', check: () => played >= 1 } ];
            const gBadges = [ { icon: 'üèÜ', name: 'Leyenda', desc: '5+ Copas', check: () => gStats.tourneys >= 5 }, { icon: 'ü¶ñ', name: 'Veterano', desc: '20+ Partidos', check: () => gStats.played >= 20 }, { icon: 'üéØ', name: 'Sniper', desc: '>60% Win', check: () => gStats.played > 10 && (gStats.won/gStats.played) > 0.6 }, { icon: 'üåü', name: 'Pro', desc: '1+ Copa', check: () => gStats.tourneys >= 1 } ];
            const render = (list, containerId) => { const cont = document.getElementById(containerId); cont.innerHTML = ''; list.forEach(b => { const unlocked = b.check(); cont.innerHTML += `<div class="flex flex-col items-center p-2 bg-black/20 rounded border border-white/10 ${unlocked ? '' : 'opacity-30 grayscale'}"><div class="text-2xl mb-1 ${unlocked ? 'medal-unlocked' : 'medal-locked'}">${b.icon}</div><div class="text-[9px] font-bold text-white leading-tight">${b.name}</div><div class="text-[8px] text-gray-400 leading-tight mt-1">${b.desc}</div></div>`; }); };
            render(cBadges, 'badgesContainerCurrent'); render(gBadges, 'badgesContainerGlobal');
        }

        window.confirmReset = async function() {
            const newStats = JSON.parse(JSON.stringify(gameState.globalStats || {}));
            gameState.players.forEach(p => { if(!newStats[p]) newStats[p] = { played: 0, won: 0, tourneys: 0 }; });
            gameState.rounds.forEach(r => { r.matches.forEach(m => { if(m.isBye) return; if(m.winner) { if(newStats[m.p1]) newStats[m.p1].played++; if(newStats[m.p2]) newStats[m.p2].played++; if(newStats[m.winner]) newStats[m.winner].won++; } }); });
            if(gameState.champion && newStats[gameState.champion]) { newStats[gameState.champion].tourneys++; }
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { active: false, rounds: [], champion: null, votes: {}, claims: {}, globalStats: newStats });
            closeResetModal();
        }

        window.createRoom = async function() {
            if (!auth.currentUser) return showToast("Conectando...", "error");
            initAudio(); const code = Math.random().toString(36).substring(2, 6).toUpperCase();
            const tName = document.getElementById('tourneyNameInput').value || "Torneo";
            const target = parseInt(document.getElementById('pointsInput').value) || 11;
            try { await setDoc(doc(db, window.DB_PATH_PREFIX, code), { tournamentName: tName, targetScore: target, players: [], playerMeta: {}, claims: {}, rounds: [], votes: {}, varTrigger: 0, active: false, champion: null, globalStats: {}, createdAt: new Date().toISOString(), creator: auth.currentUser.uid }); enterRoom(code); } catch (e) { showToast("Error: " + e.message, "error"); }
        }
        window.joinRoom = function() { const code = document.getElementById('joinCodeInput').value.trim().toUpperCase(); if (code.length < 2) return showToast("C√≥digo inv√°lido", "error"); initAudio(); enterRoom(code); }

        function enterRoom(code) {
            if (unsubscribeRoom) unsubscribeRoom(); currentRoomId = code;
            document.getElementById('lobbySection').classList.add('hidden'); document.getElementById('roomDisplay').classList.remove('hidden'); document.getElementById('roomCodeDisplay').textContent = code;
            previousRounds = null; notifiedMatches.clear();
            unsubscribeRoom = onSnapshot(doc(db, window.DB_PATH_PREFIX, code), (snap) => {
                if (snap.exists()) {
                    const newData = snap.data();
                    if (gameState.active && previousRounds && newData.rounds) checkForNewWinners(newData.rounds);
                    if (newData.varTrigger && newData.varTrigger > lastVarTime) { lastVarTime = newData.varTrigger; playVarAnimation(); }
                    gameState = newData;
                    if (!gameState.votes) gameState.votes = {}; if (!gameState.playerMeta) gameState.playerMeta = {}; if (!gameState.claims) gameState.claims = {}; if (!gameState.globalStats) gameState.globalStats = {};
                    if (gameState.rounds) previousRounds = JSON.parse(JSON.stringify(gameState.rounds));
                    syncUI(); checkMyTurn();
                } else { showToast("Sala no encontrada", "error"); exitRoom(); }
            });
        }
        function exitRoom() { currentRoomId = null; currentUserIdentity = null; document.getElementById('lobbySection').classList.remove('hidden'); document.getElementById('setupSection').classList.add('hidden'); document.getElementById('identitySection').classList.add('hidden'); document.getElementById('bracketSection').classList.add('hidden'); document.getElementById('roomDisplay').classList.add('hidden'); document.getElementById('welcomeMsg').classList.add('hidden'); document.getElementById('profileBtn').classList.add('hidden'); }

        function syncUI() {
            if (!currentUserIdentity) { if (!checkIdentity()) return; }
            if(gameState.tournamentName) document.getElementById('mainTitle').innerHTML = gameState.tournamentName.toUpperCase().replace(' ', '<br>');
            const target = gameState.targetScore || 11; document.getElementById('rulesDisplay').textContent = `A ${target} Puntos`;
            const isCreator = auth.currentUser && gameState.creator === auth.currentUser.uid;
            const resetBtn = document.getElementById('resetBtn'); if(isCreator) resetBtn.classList.remove('hidden'); else resetBtn.classList.add('hidden');
            const winnerResetBtn = document.getElementById('winnerResetBtn'); if(isCreator) winnerResetBtn.classList.remove('hidden'); else winnerResetBtn.classList.add('hidden');

            if (gameState.active) { document.getElementById('setupSection').classList.add('hidden'); document.getElementById('bracketSection').classList.remove('hidden'); renderFeaturedMatch(); renderBracket(); } 
            else { document.getElementById('bracketSection').classList.add('hidden'); if (!currentUserIdentity || isCreator) { document.getElementById('setupSection').classList.remove('hidden'); renderPlayerList(); } else { document.getElementById('setupSection').classList.remove('hidden'); renderPlayerList(); } }
            if (!document.getElementById('liveMatchModal').classList.contains('hidden') && liveMatchIndices) updateLiveMatchUI(gameState.rounds[liveMatchIndices.rIdx].matches[liveMatchIndices.mIdx]);
            const modal = document.getElementById('winnerAnnouncement'); const btn = document.getElementById('showChampionBtn');
            if (gameState.champion) { btn.classList.remove('hidden'); if (!winnerAcknowledged && modal.classList.contains('hidden')) { modal.classList.remove('hidden'); document.getElementById('winnerText').textContent = gameState.champion; document.getElementById('winnerAvatarLarge').innerHTML = getAvatar(gameState.champion, 80); confetti({ particleCount: 150, spread: 100 }); playSound('win', 0.3); } } else { btn.classList.add('hidden'); modal.classList.add('hidden'); winnerAcknowledged = false; }
            if (!document.getElementById('statsModal').classList.contains('hidden')) calculateAndRenderStats();
        }

        window.callToPlay = async function(rIdx, mIdx) { const rounds = JSON.parse(JSON.stringify(gameState.rounds)); rounds[rIdx].matches[mIdx].status = 'ready'; await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { rounds }); showToast("üì¢ ¬°Jugadores llamados!"); }
        function checkMyTurn() { if (!currentUserIdentity || !gameState.active) return; gameState.rounds.forEach((r, rIdx) => { r.matches.forEach((m, mIdx) => { if (m.isBye || m.winner) return; if ((m.p1 === currentUserIdentity || m.p2 === currentUserIdentity)) { const matchId = `r${rIdx}m${mIdx}`; const shouldNotify = (m.status === 'ready' || (m.score1 + m.score2 > 0)); if (shouldNotify && !notifiedMatches.has(matchId)) { notifiedMatches.add(matchId); showNotificationOverlay(); } } }); }); }
        function showNotificationOverlay() { document.getElementById('notificationOverlay').classList.remove('hidden'); if(navigator.vibrate) navigator.vibrate([200, 100, 200]); playSound('notify', 0.5); }
        window.closeNotification = function() { document.getElementById('notificationOverlay').classList.add('hidden'); }
        function checkForNewWinners(newRounds) { let winnerFound = false; newRounds.forEach((r, rIdx) => { r.matches.forEach((m, mIdx) => { const oldM = previousRounds[rIdx]?.matches[mIdx]; if (oldM && !oldM.winner && m.winner) { winnerFound = true; showToast(`¬°${m.winner} gan√≥ su partido!`); } }); }); if (winnerFound) { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); playSound('win', 0.3); } }
        window.triggerVar = async function() { await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { varTrigger: Date.now() }); }
        function playVarAnimation() { const overlay = document.getElementById('varOverlay'); const text = document.getElementById('varStatusText'); overlay.classList.remove('hidden'); overlay.classList.add('flex'); text.textContent = "ANALIZANDO JUGADA..."; playSound('var'); setTimeout(() => { const results = ["PUNTO V√ÅLIDO ‚úÖ", "MALA M√çA üòÖ", "SE REPITE üîÑ", "COMPRADO üí∏", "FUE AFUERA ‚ùå", "TODO LEGAL üëç"]; text.textContent = results[Math.floor(Math.random() * results.length)]; }, 2000); setTimeout(() => { overlay.classList.add('hidden'); overlay.classList.remove('flex'); }, 4500); }
        
        function renderFeaturedMatch() {
            const container = document.getElementById('featuredMatchContainer'); let activeMatch = null; let activeIndices = null;
            for(let r=0; r<gameState.rounds.length; r++) { for(let m=0; m<gameState.rounds[r].matches.length; m++) { const match = gameState.rounds[r].matches[m]; if(!match.winner && !match.isBye && match.p2) { if(match.score1 > 0 || match.score2 > 0 || match.status === 'ready') { activeMatch = match; activeIndices = {r, m}; break; } } } if(activeMatch) break; }
            if(activeMatch) {
                container.classList.remove('hidden');
                const matchKey = `${currentRoomId}_r${activeIndices.r}m${activeIndices.m}`;
                const votes = gameState.votes[matchKey] || { p1: 0, p2: 0 };
                const totalVotes = votes.p1 + votes.p2;
                const p1Pct = totalVotes === 0 ? 50 : (votes.p1 / totalVotes) * 100;
                const amIPlaying = activeMatch.p1 === currentUserIdentity || activeMatch.p2 === currentUserIdentity;
                // FIX: Only hide 'Votar' button, but keep profile clickable
                const cursorClass = amIPlaying ? '' : 'cursor-pointer hover:opacity-80 transition-opacity'; 
                // Logic: If I am playing, the click on container shouldn't vote. But clicking name should open profile.
                // Actually, click on container triggers vote. Click on Name triggers profile.
                // We need to disable the CONTAINER click for vote if playing.
                
                const voteClickAction = amIPlaying ? "" : `voteFor(${activeIndices.r},${activeIndices.m},`;
                // If playing, hide the "Votar" button visual, but keep layout
                const voteBtnStyle = amIPlaying ? 'invisible' : '';

                container.innerHTML = `<div class="w-full featured-card rounded-xl p-3 pt-6 relative overflow-hidden"><div class="absolute top-0 left-0 w-full h-1 bg-yellow-400 animate-pulse"></div><div class="text-[10px] font-bold text-yellow-400 absolute top-1 left-1/2 transform -translate-x-1/2 tracking-widest uppercase">üî• EN JUEGO üî•</div><div class="flex justify-between items-center mb-2"><div class="flex flex-col items-center w-1/3 ${cursorClass}" onclick="${voteClickAction}1)">${getAvatar(activeMatch.p1, 32)}<span class="font-bold text-white text-xs mt-1 truncate w-full text-center clickable-name" onclick="event.stopPropagation(); showProfileModal('${activeMatch.p1}')">${activeMatch.p1}</span><div class="bg-emerald-900/50 text-emerald-400 text-[9px] px-2 py-0.5 rounded border border-emerald-700/50 mt-1 ${voteBtnStyle}">Votar</div></div><div class="flex flex-col items-center justify-center w-1/3 z-10"><div class="text-3xl font-mono font-bold text-white leading-none">${activeMatch.score1}-${activeMatch.score2}</div><button onclick="openLiveMatch(${activeIndices.r},${activeIndices.m})" class="mt-1 bg-yellow-500 hover:bg-yellow-400 text-black text-[10px] font-bold px-3 py-1 rounded-full shadow-lg animate-bounce">ARBITRAR</button></div><div class="flex flex-col items-center w-1/3 ${cursorClass}" onclick="${voteClickAction}2)">${getAvatar(activeMatch.p2, 32)}<span class="font-bold text-white text-xs mt-1 truncate w-full text-center clickable-name" onclick="event.stopPropagation(); showProfileModal('${activeMatch.p2}')">${activeMatch.p2}</span><div class="bg-yellow-900/50 text-yellow-400 text-[9px] px-2 py-0.5 rounded border border-yellow-700/50 mt-1 ${voteBtnStyle}">Votar</div></div></div><div class="w-full h-1.5 bg-gray-800 rounded-full overflow-hidden flex mt-1"><div class="h-full bg-emerald-500 transition-all duration-500" style="width: ${p1Pct}%"></div><div class="h-full bg-yellow-500 flex-1"></div></div></div>`;
            } else { container.classList.add('hidden'); }
        }

        window.openLiveMatch = function(rIdx, mIdx) { const match = gameState.rounds[rIdx].matches[mIdx]; if(match.isBye) return; liveMatchIndices = { rIdx, mIdx }; document.getElementById('liveP1Name').textContent = match.p1; document.getElementById('liveP1Avatar').innerHTML = getAvatar(match.p1, 64); document.getElementById('liveP1Nick').textContent = gameState.playerMeta[match.p1]?.nickname || ""; document.getElementById('liveP2Name').textContent = match.p2; document.getElementById('liveP2Avatar').innerHTML = getAvatar(match.p2, 64); document.getElementById('liveP2Nick').textContent = gameState.playerMeta[match.p2]?.nickname || ""; updateLiveMatchUI(match); document.getElementById('liveMatchModal').classList.remove('hidden'); }
        window.closeLiveMatch = function() { document.getElementById('liveMatchModal').classList.add('hidden'); liveMatchIndices = null; }
        function updateLiveMatchUI(match) { document.getElementById('liveP1Score').textContent = match.score1; document.getElementById('liveP2Score').textContent = match.score2; const matchKey = `${currentRoomId}_r${liveMatchIndices.rIdx}m${liveMatchIndices.mIdx}`; const votes = gameState.votes[matchKey] || { p1: 0, p2: 0 }; const totalVotes = votes.p1 + votes.p2; const p1Pct = totalVotes === 0 ? 50 : (votes.p1 / totalVotes) * 100; const p2Pct = totalVotes === 0 ? 50 : (votes.p2 / totalVotes) * 100; document.getElementById('barVoteP1').style.width = `${p1Pct}%`; document.getElementById('textVoteP1').textContent = totalVotes === 0 ? '50%' : `${Math.round(p1Pct)}%`; document.getElementById('textVoteP2').textContent = totalVotes === 0 ? '50%' : `${Math.round(p2Pct)}%`; const amIPlaying = match.p1 === currentUserIdentity || match.p2 === currentUserIdentity; if(amIPlaying) { document.getElementById('voteBtnP1').classList.add('hidden'); document.getElementById('voteBtnP2').classList.add('hidden'); } else { document.getElementById('voteBtnP1').classList.remove('hidden'); document.getElementById('voteBtnP2').classList.remove('hidden'); } const target = gameState.targetScore || 11; const lead = Math.abs(match.score1 - match.score2); const maxScore = Math.max(match.score1, match.score2); const isWin = maxScore >= target && lead >= 2; const p1Area = document.getElementById('liveAreaP1'); const p2Area = document.getElementById('liveAreaP2'); if (isWin) { p1Area.classList.add('locked-add'); p2Area.classList.add('locked-add'); } else { p1Area.classList.remove('locked-add'); p2Area.classList.remove('locked-add'); } const finishBtn = document.getElementById('liveFinishBtnContainer'); if (isWin && !match.winner) { finishBtn.classList.remove('hidden'); if(maxScore === target || lead === 2) confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } }); } else { finishBtn.classList.add('hidden'); } const totalPoints = match.score1 + match.score2; let serverP1 = true; if (maxScore >= (target - 1) && match.score1 >= (target - 1) && match.score2 >= (target - 1)) { serverP1 = (totalPoints % 2) === 0; } else { const changeRate = target >= 21 ? 5 : 2; serverP1 = Math.floor(totalPoints / changeRate) % 2 === 0; } if(serverP1) { document.getElementById('liveP1Serve').classList.remove('hidden'); document.getElementById('liveP2Serve').classList.add('hidden'); } else { document.getElementById('liveP1Serve').classList.add('hidden'); document.getElementById('liveP2Serve').classList.remove('hidden'); } }
        window.voteFor = async function(rIdx, mIdx, playerNum) { let r = rIdx, m = mIdx, p = playerNum; if (arguments.length === 1) { if(!liveMatchIndices) return; r = liveMatchIndices.rIdx; m = liveMatchIndices.mIdx; p = arguments[0]; } const match = gameState.rounds[r].matches[m]; if(match.p1 === currentUserIdentity || match.p2 === currentUserIdentity) return showToast("No puedes votar en tu propio partido üëÆ", "error"); const matchKey = `${currentRoomId}_r${r}m${m}`; if(localStorage.getItem(`voted_${matchKey}`)) return showToast("Ya votaste", "error"); const votes = gameState.votes || {}; if(!votes[matchKey]) votes[matchKey] = { p1: 0, p2: 0 }; if(p === 1) votes[matchKey].p1++; else votes[matchKey].p2++; await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { votes: votes }); localStorage.setItem(`voted_${matchKey}`, "true"); showToast("Voto registrado!"); playSound('ping', 0.05); }
        window.liveScore = async function(playerNum, delta) { if(!liveMatchIndices) return; const { rIdx, mIdx } = liveMatchIndices; const rounds = JSON.parse(JSON.stringify(gameState.rounds)); const match = rounds[rIdx].matches[mIdx]; if (match.winner && delta > 0) return; if (match.winner && delta < 0) { match.winner = null; if(rounds.length === rIdx + 1) gameState.champion = null; } const target = gameState.targetScore || 11; const currentMax = Math.max(match.score1, match.score2); const lead = Math.abs(match.score1 - match.score2); const isAlreadyWon = currentMax >= target && lead >= 2; if (delta > 0 && isAlreadyWon && !match.winner) return; let newVal = (playerNum === 1 ? match.score1 : match.score2) + delta; if(newVal < 0) newVal = 0; if(playerNum === 1) match.score1 = newVal; else match.score2 = newVal; if(delta > 0) playSound('ping'); await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { rounds, champion: gameState.champion }); }
        window.finishLiveMatch = function() { if(!liveMatchIndices) return; finishMatch(liveMatchIndices.rIdx, liveMatchIndices.mIdx); closeLiveMatch(); }
        window.addPlayer = async function() { const name = document.getElementById('playerInput').value.trim(); const nick = document.getElementById('playerNickInput').value.trim(); if (!name || gameState.players.includes(name)) return; const updateData = { players: arrayUnion(name) }; if(nick) updateData[`playerMeta.${name}`] = { nickname: nick }; await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), updateData); document.getElementById('playerInput').value = ''; document.getElementById('playerNickInput').value = ''; playSound('ping'); }
        window.removePlayer = async function(idx) { const newP = [...gameState.players]; newP.splice(idx, 1); await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { players: newP }); }
        window.startTournament = async function() { if (gameState.players.length < 2) return; const shuffled = [...gameState.players].sort(() => Math.random() - 0.5); const matches = []; while (shuffled.length > 0) { const p1 = shuffled.pop(); const p2 = shuffled.length > 0 ? shuffled.pop() : null; matches.push({ p1, p2, score1: 0, score2: 0, winner: p2 ? null : p1, isBye: !p2, status: 'pending' }); } await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { rounds: [{ matches }], active: true, champion: null }); playSound('win', 0.2); }
        window.updateScore = async function(rIdx, mIdx, pNum, val) { const rounds = JSON.parse(JSON.stringify(gameState.rounds)); const match = rounds[rIdx].matches[mIdx]; if (pNum === 1) match.score1 = parseInt(val); else match.score2 = parseInt(val); await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { rounds }); }
        window.finishMatch = async function(rIdx, mIdx) { const rounds = JSON.parse(JSON.stringify(gameState.rounds)); const matches = rounds[rIdx].matches; const match = matches[mIdx]; if (match.score1 === match.score2) return showToast("No empates", "error"); match.winner = match.score1 > match.score2 ? match.p1 : match.p2; playSound('win'); let champ = null; if (matches.every(m => m.winner)) { if (matches.length === 1) champ = match.winner; else if (!rounds[rIdx + 1]) { const nextMatches = []; const winners = matches.map(m => m.winner); for (let i=0; i<winners.length; i+=2) { const p1 = winners[i], p2 = winners[i+1] || null; nextMatches.push({ p1, p2, score1: 0, score2: 0, winner: p2?null:p1, isBye: !p2, status: 'pending' }); } rounds.push({ matches: nextMatches }); } } await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { rounds, champion: champ }); }
        window.confirmReset = async function() { await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { active: false, rounds: [], champion: null, votes: {}, claims: {} }); closeResetModal(); }
        window.showStatsModal = function() { document.getElementById('statsModal').classList.remove('hidden'); calculateAndRenderStats(); }
        window.closeStatsModal = function() { document.getElementById('statsModal').classList.add('hidden'); }
        function calculateAndRenderStats() {
            const stats = {};
            gameState.players.forEach(p => { stats[p] = { name: p, played: 0, won: 0, diff: 0 }; });
            gameState.rounds.forEach(round => { round.matches.forEach(m => { if (m.isBye) return; if (m.score1 > 0 || m.score2 > 0 || m.winner) { if(stats[m.p1]) { stats[m.p1].played++; stats[m.p1].diff += (m.score1 - m.score2); } if(m.p2 && stats[m.p2]) { stats[m.p2].played++; stats[m.p2].diff += (m.score2 - m.score1); } } if (m.winner && stats[m.winner]) stats[m.winner].won++; }); });
            const sortedStats = Object.values(stats).sort((a, b) => { if (a.won !== b.won) return b.won - a.won; return b.diff - a.diff; });
            const tbody = document.getElementById('statsTableBody'); tbody.innerHTML = '';
            sortedStats.forEach((s, i) => { const isLeader = i === 0 && s.won > 0; const rowClass = isLeader ? 'bg-yellow-500/20 text-yellow-200' : 'border-b border-emerald-800/30 text-emerald-100'; const isMe = s.name === currentUserIdentity; tbody.innerHTML += `<tr class="${rowClass}"> <td class="py-2 pl-2 font-mono text-emerald-500/70">${i + 1}</td> <td class="py-2 flex items-center gap-2">${getAvatar(s.name, 24)} <span class="${isLeader ? 'font-bold' : ''} ${isMe ? 'me-highlight' : ''}">${s.name} ${isLeader ? 'üëë' : ''}</span></td> <td class="py-2 text-center font-mono">${s.played}</td> <td class="py-2 text-center font-mono font-bold">${s.won}</td> <td class="py-2 text-center font-mono text-xs ${s.diff > 0 ? 'text-green-400' : 'text-red-400'}">${s.diff > 0 ? '+' : ''}${s.diff}</td> </tr>`; });
        }
        window.copyRoomCode = function() { const code = document.getElementById('roomCodeDisplay').textContent; navigator.clipboard.writeText(code).then(() => showToast("C√≥digo copiado!")); }
        window.toggleFullScreen = function() { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e => console.log(e)); else if (document.exitFullscreen) document.exitFullscreen(); }
        window.handleEnter = (e) => { if(e.key === 'Enter') addPlayer(); };
        window.showResetModal = () => document.getElementById('resetModal').classList.remove('hidden');
        window.closeResetModal = () => document.getElementById('resetModal').classList.add('hidden');
        window.closeWinnerModal = () => { document.getElementById('winnerAnnouncement').classList.add('hidden'); winnerAcknowledged = true; };
        window.showWinnerModal = () => { winnerAcknowledged = false; document.getElementById('winnerAnnouncement').classList.remove('hidden'); };
        
        function renderBracket() {
            const container = document.getElementById('roundsContainer'); container.innerHTML = '';
            gameState.rounds.forEach((r, rIdx) => {
                const roundDiv = document.createElement('div'); roundDiv.className = "min-w-[85vw] md:min-w-[350px] flex flex-col gap-3 snap-center shrink-0 pb-4";
                roundDiv.innerHTML = `<h3 class="text-center font-bold text-emerald-400 bg-emerald-900/80 backdrop-blur-sm py-2 rounded mb-2 sticky top-0 z-10">Ronda ${rIdx + 1}</h3>`;
                r.matches.forEach((m, mIdx) => {
                    const done = m.winner !== null; const p1W = m.winner === m.p1; const p2W = m.winner === m.p2;
                    let justWonClass = ""; if (done && previousRounds && previousRounds[rIdx]?.matches[mIdx] && !previousRounds[rIdx].matches[mIdx].winner) justWonClass = "just-won";
                    let statusBadge = ''; if(done) statusBadge = `<span class="badge-status status-done">FINALIZADO</span>`; else if(!m.isBye && (m.score1 > 0 || m.score2 > 0 || m.status==='ready')) statusBadge = `<span class="badge-status status-live">‚óè EN JUEGO</span>`; else if(!m.isBye) statusBadge = `<span class="badge-status status-new">SIN INICIAR</span>`;
                    let html = `<div class="glass-panel rounded-lg p-3 border-l-4 ${done ? 'border-l-yellow-400' : 'border-l-emerald-500'} relative ${justWonClass}">`;
                    if(!m.isBye) html += `<div class="flex justify-end mb-2">${statusBadge}</div>`;
                    if(m.isBye) { html += `<div class="text-center py-4"><div class="font-bold text-white flex justify-center items-center gap-2">${getAvatar(m.p1, 32)} <span class="${m.p1 === currentUserIdentity ? 'me-highlight' : ''} clickable-name" onclick="showProfileModal('${m.p1}')">${m.p1}</span></div><div class="text-xs text-emerald-400 mt-1">BYE</div></div>`; } 
                    else {
                        const n1 = gameState.playerMeta[m.p1]?.nickname || ""; const n2 = gameState.playerMeta[m.p2]?.nickname || "";
                        html += `<div class="flex justify-between items-center mb-2 ${p1W ? 'text-yellow-400 font-bold' : 'text-white'}"><span class="truncate w-32 text-sm"><div class="flex items-center gap-2">${getAvatar(m.p1)} <span class="${m.p1 === currentUserIdentity ? 'me-highlight' : ''} clickable-name" onclick="showProfileModal('${m.p1}')">${m.p1}</span></div>${n1 ? `<div class="text-[10px] text-emerald-400/60 ml-8 italic">${n1}</div>` : ''}</span><span class="font-mono font-bold text-xl">${m.score1}</span></div>`;
                        html += `<div class="flex justify-between items-center mt-2 ${p2W ? 'text-yellow-400 font-bold' : 'text-white'}"><span class="truncate w-32 text-sm"><div class="flex items-center gap-2">${getAvatar(m.p2||'?')} <span class="${m.p2 === currentUserIdentity ? 'me-highlight' : ''} clickable-name" onclick="showProfileModal('${m.p2}')">${m.p2||'?'}</span></div>${n2 ? `<div class="text-[10px] text-emerald-400/60 ml-8 italic">${n2}</div>` : ''}</span><span class="font-mono font-bold text-xl">${m.score2}</span></div><div class="flex gap-2 mt-3">`;
                        if(!done && m.p2) {
                            const isCreator = auth.currentUser && gameState.creator === auth.currentUser.uid;
                            if(m.status !== 'ready' && m.score1 === 0 && m.score2 === 0 && isCreator) { html += `<button onclick="callToPlay(${rIdx},${mIdx})" class="flex-1 bg-blue-600/50 hover:bg-blue-500 text-blue-200 border border-blue-500/30 py-2 rounded text-xs font-bold transition-colors"><i class="fas fa-bullhorn mr-1"></i> LLAMAR</button>`; } 
                            else { html += `<button onclick="openLiveMatch(${rIdx},${mIdx})" class="flex-1 bg-emerald-800/50 hover:bg-emerald-700 text-emerald-300 border border-emerald-600/30 py-2 rounded text-xs font-bold transition-colors flex items-center justify-center gap-2"><i class="fas fa-gamepad"></i> ARBITRAR</button>`; }
                        }
                        else if (done) html += `<div class="w-full text-center text-xs text-yellow-500/70 font-bold py-1">GANADOR: ${m.winner}</div>`;
                        html += `</div>`;
                    }
                    html += `</div>`; roundDiv.innerHTML += html;
                });
                container.appendChild(roundDiv);
            });
        }

        function renderPlayerList() {
            const list = document.getElementById('playerList'); list.innerHTML = '';
            gameState.players.forEach((p, i) => {
                const nick = gameState.playerMeta[p]?.nickname || ""; const isMe = p === currentUserIdentity; const isCreator = auth.currentUser && gameState.creator === auth.currentUser.uid; const removeBtn = isCreator ? `<button onclick="removePlayer(${i})" class="text-red-400 hover:bg-red-500/20 p-1 rounded"><i class="fas fa-times"></i></button>` : '';
                list.innerHTML += `<li class="flex justify-between items-center bg-emerald-800/40 px-3 py-2 rounded border border-emerald-700/50 animate-fade-in"><div><span class="text-white font-medium flex items-center gap-2 clickable-name" onclick="showProfileModal('${p}')">${getAvatar(p, 32)} <span class="${isMe ? 'me-highlight' : ''}">${p}</span></span>${nick ? `<div class="text-[10px] text-emerald-400 italic ml-10">${nick}</div>` : ''}</div>${removeBtn}</li>`;
            });
            document.getElementById('playerCount').textContent = `${gameState.players.length} Jugadores`;
            document.getElementById('startBtn').disabled = gameState.players.length < 2;
        }

        initApp();
    </script>
</body>
</html>