<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ping Pong Master - Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1a2e22;
            background-image: radial-gradient(#2d4a37 15%, transparent 16%), radial-gradient(#2d4a37 15%, transparent 16%);
            background-size: 60px 60px;
            background-position: 0 0, 30px 30px;
            color: #ecfdf5;
            overscroll-behavior-y: none;
        }
        .retro-font { font-family: 'Press Start 2P', cursive; }
        .glass-panel {
            background: rgba(16, 185, 129, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(16, 185, 129, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .match-card { transition: all 0.3s ease; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-bounce-paddle { animation: bounce-paddle 2s infinite; }
        @keyframes bounce-paddle {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(10deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-2 md:p-4 overflow-x-hidden">

    <!-- INDICADOR DE VERSI칍N -->
    <div class="fixed top-0 right-0 bg-emerald-900/50 text-emerald-400 text-[10px] px-2 py-1 z-50 font-mono border-b border-l border-emerald-500/30 rounded-bl-lg">
        v2.1 (Cloud Fix)
    </div>

    <!-- Header -->
    <header class="w-full max-w-3xl text-center mb-6 mt-2">
        <div class="flex justify-center items-center gap-3 mb-2">
            <i class="fas fa-table-tennis text-2xl md:text-4xl text-orange-400 animate-bounce-paddle"></i>
            <h1 class="text-xl md:text-4xl text-white retro-font text-shadow-md leading-tight">PING PONG<br><span class="text-emerald-400 text-lg md:text-2xl">ONLINE</span></h1>
        </div>
        <!-- Connection Status -->
        <div id="connectionStatus" class="text-xs font-mono text-yellow-500 animate-pulse">
            <i class="fas fa-wifi"></i> Conectando a la nube...
        </div>
        <div id="roomDisplay" class="hidden mt-2 bg-emerald-900/80 px-4 py-1 rounded-full border border-emerald-500/50 inline-block">
            <span class="text-emerald-400 text-xs uppercase tracking-wider mr-2">C칍DIGO DE SALA:</span>
            <span id="roomCodeDisplay" class="text-white font-bold font-mono text-lg tracking-widest">----</span>
        </div>
    </header>

    <!-- LOBBY SECTION -->
    <div id="lobbySection" class="w-full max-w-sm glass-panel rounded-xl p-6 mb-8 text-center transition-all duration-500">
        <h2 class="text-xl font-bold text-white mb-6">Bienvenido</h2>
        
        <button onclick="createRoom()" class="w-full bg-orange-500 hover:bg-orange-400 text-white font-bold py-3 px-4 rounded-lg shadow-lg mb-4 transition-transform active:scale-95 flex items-center justify-center gap-2">
            <i class="fas fa-plus-circle"></i> CREAR NUEVO TORNEO
        </button>
        
        <div class="relative flex py-2 items-center">
            <div class="flex-grow border-t border-emerald-700"></div>
            <span class="flex-shrink-0 mx-4 text-emerald-500 text-xs">O UNIRSE A UNO</span>
            <div class="flex-grow border-t border-emerald-700"></div>
        </div>

        <div class="mt-4 flex gap-2">
            <input type="text" id="joinCodeInput" placeholder="C칍DIGO (ej: AB12)" maxlength="4" 
                class="flex-1 bg-emerald-900/50 border border-emerald-600 rounded-lg px-4 py-2 text-white text-center font-mono uppercase placeholder-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-400 h-12">
            <button onclick="joinRoom()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold px-4 rounded-lg transition-colors h-12">
                ENTRAR
            </button>
        </div>
    </div>

    <!-- SETUP SECTION -->
    <div id="setupSection" class="w-full max-w-md glass-panel rounded-xl p-4 md:p-6 mb-8 hidden mx-2">
        <h2 class="text-lg md:text-xl font-bold text-emerald-300 mb-4 flex items-center gap-2">
            <i class="fas fa-users"></i> Jugadores en Sala
        </h2>
        
        <div class="flex gap-2 mb-4">
            <input type="text" id="playerInput" placeholder="Tu nombre..." 
                class="flex-1 bg-emerald-900/50 border border-emerald-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-emerald-400"
                onkeypress="handleEnter(event)">
            <button onclick="addPlayer()" class="bg-emerald-500 hover:bg-emerald-400 text-emerald-950 font-bold py-2 px-4 rounded-lg shadow-lg">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <ul id="playerList" class="space-y-2 mb-6 max-h-60 overflow-y-auto">
            <!-- Players list -->
        </ul>

        <div class="flex justify-between items-center pt-4 border-t border-emerald-700/50">
            <span class="text-emerald-400 text-sm font-mono" id="playerCount">Total: 0</span>
            <button onclick="startTournament()" id="startBtn" disabled
                class="bg-orange-500 hover:bg-orange-400 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-2 px-6 rounded-lg shadow-lg active:translate-y-1 transition-all">
                EMPEZAR <i class="fas fa-play ml-2"></i>
            </button>
        </div>
    </div>

    <!-- BRACKET SECTION -->
    <div id="bracketSection" class="w-full max-w-6xl hidden flex flex-col h-[80vh]">
        <div class="flex justify-between items-center mb-4 glass-panel p-3 rounded-lg mx-2">
            <h2 class="text-lg font-bold text-white"><i class="fas fa-trophy text-yellow-400 mr-2"></i> Torneo</h2>
            
            <div class="flex gap-2">
                <button id="showChampionBtn" onclick="showWinnerModal()" class="hidden bg-yellow-500/20 text-yellow-400 border border-yellow-500/50 rounded px-3 py-1 text-xs hover:bg-yellow-500/40 transition-colors font-bold">
                    <i class="fas fa-crown"></i> Ver Campe칩n
                </button>
                
                <button onclick="showResetModal()" class="text-red-400 border border-red-500/30 rounded px-3 py-1 text-xs hover:bg-red-500/10">
                    <i class="fas fa-trash-alt"></i> Reiniciar
                </button>
            </div>
        </div>

        <div id="roundsContainer" class="flex flex-row gap-4 overflow-x-auto pb-8 snap-x snap-mandatory px-4 w-full no-scrollbar">
            <!-- Bracket content -->
        </div>
    </div>

    <!-- Winner Modal -->
    <div id="winnerAnnouncement" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="glass-panel p-8 rounded-2xl border-2 border-yellow-400 animate-pulse text-center max-w-sm w-full shadow-[0_0_50px_rgba(234,179,8,0.5)]">
            <h3 class="text-2xl text-yellow-300 font-bold mb-2">춰CAMPE칍N!</h3>
            <div class="text-5xl my-6 font-bold text-white" id="winnerText">游녬</div>
            
            <div class="flex flex-col gap-3 w-full">
                <button onclick="closeWinnerModal()" class="bg-transparent border border-yellow-500/50 text-yellow-200 hover:bg-yellow-500/10 font-bold py-3 px-8 rounded-full w-full transition-colors">
                    Ver Tabla
                </button>
                <button onclick="showResetModal()" class="bg-yellow-500 text-yellow-900 font-bold py-3 px-8 rounded-full w-full hover:bg-yellow-400 transition-colors shadow-lg">
                    Nuevo Torneo
                </button>
            </div>
        </div>
    </div>

    <!-- Modals & Toasts -->
    <div id="toast" class="fixed bottom-4 right-4 bg-emerald-600 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50"></div>
    
    <div id="resetModal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50 backdrop-blur-sm">
        <div class="glass-panel p-6 rounded-xl max-w-sm w-full mx-4 text-center border border-red-500/30">
            <h3 class="text-xl font-bold text-white mb-2">Reiniciar?</h3>
            <p class="text-emerald-200/70 mb-6">Esto borrar치 el progreso para todos los conectados.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeResetModal()" class="px-4 py-2 rounded-lg text-emerald-200 border border-emerald-500/30">Cancelar</button>
                <button onclick="confirmReset()" class="px-4 py-2 rounded-lg bg-red-600 text-white font-bold">S칤, Reiniciar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- FIREBASE SETUP ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        
        try {
            // Intenta leer config del entorno de desarrollo (Codespaces/Preview)
            if (typeof __firebase_config !== 'undefined') {
                 firebaseConfig = JSON.parse(__firebase_config);
            } else {
                throw new Error("No preview config");
            }
        } catch (e) {
            // Configuraci칩n para producci칩n (GitHub Pages)
            // Los valores __XXX__ ser치n reemplazados autom치ticamente por GitHub Actions
            firebaseConfig = {
                apiKey: "__API_KEY__",
                authDomain: "__AUTH_DOMAIN__",
                projectId: "__PROJECT_ID__",
                storageBucket: "__STORAGE_BUCKET__",
                messagingSenderId: "__MESSAGING_SENDER_ID__",
                appId: "__APP_ID__"
            };
        }

        let app, auth, db, user;
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let winnerAcknowledged = false;

        let gameState = {
            players: [],
            rounds: [],
            active: false,
            champion: null
        };

        async function initApp() {
            // --- CORRECCI칍N AQU칈 ---
            // Antes verific치bamos si era igual a "__API_KEY__".
            // Ahora verificamos si empieza con "__".
            // Si GitHub hizo el reemplazo, la clave empezar치 con "AIza..." (no con "__").
            // Si NO hizo el reemplazo, seguir치 siendo "__API_KEY__".
            
            if (firebaseConfig.apiKey.startsWith("__")) {
                updateStatus("Falta Configuraci칩n (Local)", "text-orange-400");
                console.warn("Firebase no configurado. Si est치s en local, usa 'npm start'.");
                // No hacemos return para permitir que falle con error m치s descriptivo de Firebase si es necesario,
                // o simplemente mostrar el aviso.
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Determinar App ID
                const appId = firebaseConfig.projectId && !firebaseConfig.projectId.startsWith("__") 
                    ? firebaseConfig.projectId 
                    : 'ping-pong-app';
                
                window.DB_PATH_PREFIX = `artifacts/${appId}/public/data/tournaments`;

                await signInAnonymously(auth);
                updateStatus("Conectado a la Nube", "text-emerald-400");
            } catch (error) {
                console.error("Error de inicializaci칩n:", error);
                // Si falla es probable que las credenciales est칠n mal o sea el problema de reemplazo
                updateStatus("Error de Conexi칩n", "text-red-500");
            }
        }

        function updateStatus(msg, colorClass) {
            const el = document.getElementById('connectionStatus');
            if(el) {
                el.innerHTML = `<i class="fas fa-wifi"></i> ${msg}`;
                el.className = `text-xs font-mono ${colorClass}`;
            }
        }

        // --- RESTO DEL C칍DIGO (L칩gica del juego) ---
        // ... (Sin cambios en la l칩gica del juego)

        window.createRoom = async function() {
            if (!auth.currentUser) return showToast("Esperando conexi칩n...", "error");
            const code = Math.random().toString(36).substring(2, 6).toUpperCase();
            const roomRef = doc(db, window.DB_PATH_PREFIX, code);
            const initialState = {
                players: [], rounds: [], active: false, champion: null,
                createdAt: new Date().toISOString(), creator: auth.currentUser.uid
            };
            try { await setDoc(roomRef, initialState); enterRoom(code); } catch (e) { showToast("Error: " + e.message, "error"); }
        }

        window.joinRoom = function() {
            const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
            if (code.length < 2) return showToast("C칩digo inv치lido", "error");
            enterRoom(code);
        }

        function enterRoom(code) {
            if (unsubscribeRoom) unsubscribeRoom();
            currentRoomId = code;
            document.getElementById('lobbySection').classList.add('hidden');
            document.getElementById('roomDisplay').classList.remove('hidden');
            document.getElementById('roomCodeDisplay').textContent = code;
            const roomRef = doc(db, window.DB_PATH_PREFIX, code);
            unsubscribeRoom = onSnapshot(roomRef, (snapshot) => {
                if (snapshot.exists()) {
                    gameState = snapshot.data();
                    syncUI();
                } else {
                    showToast("La sala no existe", "error");
                    exitRoom();
                }
            }, (error) => { console.error(error); showToast("Error de sincronizaci칩n", "error"); });
        }

        function exitRoom() {
            currentRoomId = null;
            document.getElementById('lobbySection').classList.remove('hidden');
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('bracketSection').classList.add('hidden');
            document.getElementById('roomDisplay').classList.add('hidden');
            winnerAcknowledged = false;
        }

        function syncUI() {
            if (gameState.active) {
                document.getElementById('setupSection').classList.add('hidden');
                document.getElementById('bracketSection').classList.remove('hidden');
                renderBracket();
            } else {
                document.getElementById('bracketSection').classList.add('hidden');
                document.getElementById('setupSection').classList.remove('hidden');
                renderPlayerList();
            }
            const modal = document.getElementById('winnerAnnouncement');
            const championBtn = document.getElementById('showChampionBtn');
            if (gameState.champion) {
                championBtn.classList.remove('hidden');
                if (!winnerAcknowledged && modal.classList.contains('hidden')) {
                     modal.classList.remove('hidden');
                     document.getElementById('winnerText').textContent = `游끥 ${gameState.champion} 游끥`;
                     confetti({ particleCount: 150, spread: 100 });
                }
            } else {
                championBtn.classList.add('hidden');
                modal.classList.add('hidden');
                winnerAcknowledged = false;
            }
        }

        window.closeWinnerModal = () => { document.getElementById('winnerAnnouncement').classList.add('hidden'); winnerAcknowledged = true; }
        window.showWinnerModal = () => { winnerAcknowledged = false; document.getElementById('winnerAnnouncement').classList.remove('hidden'); confetti({ particleCount: 150, spread: 100 }); }

        window.addPlayer = async function() {
            const input = document.getElementById('playerInput');
            const name = input.value.trim();
            if (!name) return showToast("Escribe un nombre", "error");
            if (gameState.players.includes(name)) return showToast("Ya existe", "error");
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { players: arrayUnion(name) });
            input.value = ''; input.focus();
        }

        window.removePlayer = async function(index) {
            const newPlayers = [...gameState.players]; newPlayers.splice(index, 1);
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { players: newPlayers });
        }

        window.startTournament = async function() {
            if (gameState.players.length < 2) return;
            const shuffled = [...gameState.players].sort(() => Math.random() - 0.5);
            const round1Matches = [];
            while (shuffled.length > 0) {
                const p1 = shuffled.pop(); const p2 = shuffled.length > 0 ? shuffled.pop() : null;
                round1Matches.push({ p1, p2, score1: 0, score2: 0, winner: p2 === null ? p1 : null, isBye: p2 === null });
            }
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { rounds: [{ matches: round1Matches }], active: true, champion: null });
        }

        window.updateScore = async function(rIdx, mIdx, pNum, val) {
            const newRounds = JSON.parse(JSON.stringify(gameState.rounds));
            const match = newRounds[rIdx].matches[mIdx];
            if (pNum === 1) match.score1 = parseInt(val); else match.score2 = parseInt(val);
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { rounds: newRounds });
        }

        window.finishMatch = async function(rIdx, mIdx) {
            const newRounds = JSON.parse(JSON.stringify(gameState.rounds));
            const currentRoundMatches = newRounds[rIdx].matches;
            const match = currentRoundMatches[mIdx];
            if (match.score1 === match.score2) return showToast("No empates", "error");
            match.winner = match.score1 > match.score2 ? match.p1 : match.p2;
            
            let updatedChampion = null;
            if (currentRoundMatches.every(m => m.winner)) {
                if (currentRoundMatches.length === 1) updatedChampion = match.winner;
                else if (!newRounds[rIdx + 1]) {
                    const winners = currentRoundMatches.map(m => m.winner);
                    const nextRoundMatches = [];
                    for (let i = 0; i < winners.length; i += 2) {
                        const p1 = winners[i]; const p2 = winners[i+1] || null;
                        nextRoundMatches.push({ p1, p2, score1: 0, score2: 0, winner: p2 === null ? p1 : null, isBye: p2 === null });
                    }
                    newRounds.push({ matches: nextRoundMatches });
                }
            }
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { rounds: newRounds, champion: updatedChampion });
        }

        window.confirmReset = async function() {
            await updateDoc(doc(db, window.DB_PATH_PREFIX, currentRoomId), { active: false, rounds: [], champion: null });
            winnerAcknowledged = false; closeResetModal();
        }

        // Rendering Logic
        function renderPlayerList() {
            const list = document.getElementById('playerList'); list.innerHTML = '';
            gameState.players.forEach((p, i) => {
                list.innerHTML += `<li class="flex justify-between items-center bg-emerald-800/40 px-3 py-2 rounded border border-emerald-700/50"><span class="text-white font-medium"><i class="fas fa-user text-emerald-400 mr-2"></i>${p}</span><button onclick="removePlayer(${i})" class="text-red-400 hover:bg-red-500/20 p-1 rounded"><i class="fas fa-times"></i></button></li>`;
            });
            document.getElementById('playerCount').textContent = `Total: ${gameState.players.length}`;
            document.getElementById('startBtn').disabled = gameState.players.length < 2;
        }

        function renderBracket() {
            const container = document.getElementById('roundsContainer'); container.innerHTML = '';
            gameState.rounds.forEach((roundWrapper, rIdx) => {
                const matches = roundWrapper.matches;
                const roundDiv = document.createElement('div');
                roundDiv.className = "min-w-[85vw] md:min-w-[350px] flex flex-col gap-3 snap-center shrink-0 pb-4";
                roundDiv.innerHTML = `<h3 class="text-center font-bold text-emerald-400 bg-emerald-900/80 backdrop-blur-sm py-2 rounded mb-2 sticky top-0 z-10">Ronda ${rIdx + 1}</h3>`;
                matches.forEach((match, mIdx) => {
                    const isFinished = match.winner !== null; const p1W = match.winner === match.p1; const p2W = match.winner === match.p2;
                    let html = `<div class="glass-panel rounded-lg p-3 border-l-4 ${isFinished ? 'border-l-yellow-400' : 'border-l-emerald-500'}">`;
                    if (match.isBye) html += `<div class="text-center py-4"><div class="font-bold text-white">${match.p1}</div><div class="text-xs text-emerald-400">BYE</div></div>`;
                    else {
                        html += `<div class="flex justify-between items-center mb-2 ${p1W ? 'text-yellow-400 font-bold' : 'text-white'}"><span class="truncate w-32">${match.p1} ${p1W ? '游녬' : ''}</span><input type="number" value="${match.score1}" onchange="updateScore(${rIdx},${mIdx},1,this.value)" ${isFinished?'disabled':''} class="w-12 bg-emerald-900 border border-emerald-600 text-center rounded text-white h-10 text-lg"></div>`;
                        html += `<div class="flex justify-between items-center mt-2 ${p2W ? 'text-yellow-400 font-bold' : 'text-white'}"><span class="truncate w-32">${match.p2} ${p2W ? '游녬' : ''}</span><input type="number" value="${match.score2}" onchange="updateScore(${rIdx},${mIdx},2,this.value)" ${isFinished?'disabled':''} class="w-12 bg-emerald-900 border border-emerald-600 text-center rounded text-white h-10 text-lg"></div>`;
                        if (!isFinished) html += `<button onclick="finishMatch(${rIdx},${mIdx})" class="w-full mt-3 bg-emerald-600 text-white font-bold py-2 rounded">FINALIZAR</button>`;
                    }
                    html += `</div>`; roundDiv.innerHTML += html;
                });
                container.appendChild(roundDiv);
            });
        }

        window.handleEnter = (e) => { if(e.key === 'Enter') addPlayer(); };
        window.showResetModal = () => document.getElementById('resetModal').classList.remove('hidden');
        window.closeResetModal = () => document.getElementById('resetModal').classList.add('hidden');
        window.showToast = (msg, type) => {
            const toast = document.getElementById('toast'); toast.textContent = msg;
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-xl transition-all duration-300 z-50 ${type==='error'?'bg-red-600':'bg-emerald-600'} text-white`;
            setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        };

        initApp();
    </script>
</body>
</html>